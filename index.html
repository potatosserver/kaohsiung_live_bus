<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高雄市公車動態查詢器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght%40400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
            /* Padding bottom will be handled dynamically by JS for specific pages */
            user-select: none; /* 鎖定文字選取 */
            -webkit-user-select: none; /* For Safari */
            -moz-user-select: none; /* For Firefox */
            -ms-user-select: none; /* For Internet Explorer/Edge */
        }
        /* Loading Spinner Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1.2s linear infinite;
        }
        /* Page transition styles */
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* Custom scrollbar - Hidden but scrollable */
        ::-webkit-scrollbar {
            width: 0px; /* For vertical scrollbar */
            height: 0px; /* For horizontal scrollbar */
        }
        ::-webkit-scrollbar-track {
            background: transparent; /* Make track transparent */
        }
        ::-webkit-scrollbar-thumb {
            background: transparent; /* Make thumb transparent */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: transparent; /* Make thumb transparent on hover */
        }
        /* Updated Material Icons class name */
        .material-icons-outlined {
            font-size: 24px;
        }
        /* Ensure the body has enough padding at the bottom for the fixed keyboard */
        /* This will be set dynamically by JavaScript */
        #routeSelectionPage .container {
            padding-bottom: 20px; /* Default, will be overridden by JS */
        }
        @media (min-width: 768px) {
            #routeSelectionPage .container {
                padding-bottom: 30px; /* Default, will be overridden by JS */
            }
        }

        /* For "公車小黃" button to wrap text on narrow screens */
        .bus-taxi-button {
            line-height: 1.2;
            white-space: normal;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0.4rem 0.2rem; 
        }

        /* Force line break for "公車" and "小黃" on narrow screens */
        .bus-taxi-button .bus-text,
        .bus-taxi-button .taxi-text {
            display: block; 
        }

        @media (min-width: 768px) {
            .bus-taxi-button {
                padding: 0.75rem;
                flex-direction: row;
                white-space: nowrap;
            }
            .bus-taxi-button .bus-text,
            .bus-taxi-button .taxi-text {
                display: inline;
            }
        }

        /* Styles for the new update countdown button */
        #updateCountdown {
            white-space: nowrap;
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 8px 16px;
            background-color: #e0f2fe; /* Light blue */
            color: #333;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            width: auto;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer; /* Add cursor pointer for interactivity */
        }

        #updateCountdown:hover {
            background-color: #bfdbfe; /* Lighter blue on hover */
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }

        body.dark-mode #updateCountdown {
            background-color: #e8def8;
            color: #1c1b1f;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        body.dark-mode #updateCountdown:hover {
            background-color: #d0bcff;
            color: #1c1b1f;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
        }

        #updateCountdown .material-icons-outlined { /* Changed to material-icons-outlined */
            font-size: 18px;
            vertical-align: middle;
        }

        @keyframes spin-180 {
            from { transform: rotate(0deg); }
            to { transform: rotate(180deg); }
        }

        .spin-update {
            animation: spin-180 0.5s ease forwards;
        }
        
        /* --- START: NEW STYLES FOR KEYBOARD --- */
        /* Styles for the keyboard to make buttons square on narrow screens */
        @media (max-width: 767px) { /* Below Tailwind's 'md' breakpoint */
            #filterKeyboard {
                gap: 4px !important; /* Consistent gap, equivalent to Tailwind's gap-1. Use !important to override Tailwind. */
                max-width: 384px; /* Constrain width, equivalent to max-w-sm */
                margin-left: auto;
                margin-right: auto;
            }

            #filterKeyboard > button {
                aspect-ratio: 1 / 1; /* Force square shape */
                padding: 0; /* Remove padding to allow content to fill the square */
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* The bus-taxi button needs special handling for its text */
            #filterKeyboard .bus-taxi-button {
                padding: 4px; /* Add a little padding back for the two-line text */
                line-height: 1.1;
            }
        }
        /* --- END: NEW STYLES FOR KEYBOARD --- */

        /* Styles for the main navigation bar */
        #mainNav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff; /* White background */
            border-top: 1px solid #e2e8f0; /* Light border top */
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
        }
        #mainNav button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            padding: 4px 4px; /* Reduced padding from 8px to 4px */
            font-size: 0.8rem;
            color: #64748b; /* Slate-500 equivalent */
            background-color: transparent;
            border: none;
            cursor: pointer;
            transition: color 0.2s, background-color 0.2s;
        }
        #mainNav button .material-icons-outlined {
            font-size: 28px; /* Larger icons */
            margin-bottom: 4px;
        }
        #mainNav button:hover {
            color: #3b82f6; /* Blue-500 equivalent */
        }
        #mainNav button.active-nav {
            color: #3b82f6; /* Blue-500 equivalent */
            font-weight: 600;
        }

        /* Styles for the floating favorite button */
        #favoriteActionButton {
            position: fixed;
            padding: 8px 16px;
            background-color: #1d4ed8; /* A darker, more vibrant blue */
            color: white;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 0.9em;
            cursor: pointer;
            z-index: 2000; /* Above everything */
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.2s; /* Added background-color to transition */
            transform: translateY(10px);
        }
        #favoriteActionButton.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        #favoriteActionButton:hover {
            background-color: #2563eb; /* Slightly lighter blue on hover */
        }


        /* Styles for toast messages */
        .toast-message {
            position: fixed;
            bottom: 80px; /* Above the nav bar */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none; /* Allow clicks to pass through */
        }
        .toast-message.show {
            opacity: 1;
        }

        /* Styles for the station list in bus tracker page */
        #stationList {
            position: relative; /* For positioning the line */
            padding-left: 20px; /* Space for the line and icons */
        }

        #stationList::before {
            content: '';
            position: absolute;
            left: 21px; /* Adjusted to align with the center of the dots/hearts */
            top: 0;
            bottom: 0;
            width: 2px; /* Line thickness */
            background-color: #cbd5e1; /* Slate-300 equivalent */
            z-index: 0; /* Ensure line is behind icons */
        }

        .station-item {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 12px; /* Spacing between items */
        }

        .station-item:last-child {
            margin-bottom: 0; /* No margin for the last item */
        }

        .station-icon-container {
            position: absolute;
            left: -19px; /* Adjust to place the icon/dot over the line */
            z-index: 1; /* Ensure icon is above the line */
            background-color: #f1f5f9; /* Match body background to hide line intersection */
            border-radius: 50%; /* For the dot/heart background */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px; /* Size of the icon container */
            height: 40px;
        }

        .station-dot {
            width: 12px;
            height: 12px;
            background-color: #3b82f6; /* Blue dot */
            border-radius: 50%;
        }

        .station-content {
            flex: 1;
            padding: 12px; /* Padding inside the card */
            background-color: #ffffff; /* White background for the card */
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-left: 20px; /* Push content to the right of the line/icon */
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px; /* Space between time and name */
        }

        .station-content .time-pill {
            flex-shrink: 0; /* Prevent time pill from shrinking */
            min-width: 90px; /* Fixed width for time pill */
            text-align: center;
            padding: 6px 8px;
            border-radius: 9999px; /* Full rounded corners */
            font-weight: 700; /* Bold */
            font-size: 0.9em;
        }

        .station-content .station-name {
            flex-grow: 1; /* Allow station name to take available space */
            font-weight: 500;
            color: #1e293b;
        }

        .station-content .bus-id-display {
            flex-shrink: 0; /* Prevent bus ID from shrinking */
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background-color: #dbeafe; /* Blue-100 */
            color: #1e40af; /* Blue-800 */
            font-size: 0.75em;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 9999px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="antialiased">

    <div id="routeSelectionPage" class="page">
        <div class="container mx-auto p-4 md:p-6 max-w-4xl">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-800">高雄市公車路線查詢</h1>
                <p class="text-slate-500 mt-2">請使用下方鍵盤或直接輸入以查詢路線</p>
            </header>
            
            <!-- START: Modified Search Bar -->
            <div class="flex items-center gap-2 mb-4 bg-white border-2 border-slate-300 rounded-xl shadow-sm p-1">
                <!-- Special Category Display -->
                <div class="flex-shrink-0 pl-3 pr-2">
                    <span id="categoryDisplay" class="font-semibold text-blue-600">全部路線</span>
                </div>
                
                <!-- Vertical Separator -->
                <div class="w-px bg-slate-300 self-stretch my-2"></div>
            
                <!-- Search Input Area -->
                <div class="relative flex-grow">
                    <!-- The input is now for numbers, readonly, text-left, and borderless -->
                    <input type="text" id="routeSearchInput" placeholder="請由鍵盤輸入號碼" class="w-full p-3 text-lg bg-transparent border-none focus:outline-none focus:ring-0 text-left" readonly>
                    <!-- The icon is moved to the right for better alignment -->
                    <svg class="w-6 h-6 text-slate-400 absolute top-1/2 right-3 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
            <!-- END: Modified Search Bar -->


            <div id="initialLoading" class="text-center py-20">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-4 text-slate-600">正在載入所有路線...</p>
            </div>
            
            <div id="routeListContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-4">
                </div>
             <p id="noResultsMessage" class="text-center py-10 text-slate-500 text-lg hidden">找不到相符的路線。</p>
        </div>

        <div id="filterKeyboardContainer" class="fixed bottom-[70px] left-0 right-0 bg-slate-100 py-0 px-4 z-[999] shadow-lg">
            <div class="container mx-auto max-w-4xl">
                <div id="filterKeyboard" class="grid grid-cols-5 gap-x-0.5 gap-y-1 md:gap-2 py-2">
                    <button data-filter="紅" data-type="category" class="p-3 text-black font-bold bg-red-500 rounded-lg shadow-md hover:bg-red-600 transition-colors">紅</button>
                    <button data-filter="其他" data-type="category" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">其他</button>
                    <button data-filter="1" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">1</button>
                    <button data-filter="2" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">2</button>
                    <button data-filter="3" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">3</button>
                    
                    <button data-filter="橘" data-type="category" class="p-3 text-black font-bold bg-orange-500 rounded-lg shadow-md hover:bg-orange-600 transition-colors">橘</button>
                    <button data-filter="幹線" data-type="category" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">幹線</button>
                    <button data-filter="4" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">4</button>
                    <button data-filter="5" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">5</button>
                    <button data-filter="6" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">6</button>

                    <button data-filter="黃" data-type="category" class="p-3 text-black font-bold bg-yellow-400 rounded-lg shadow-md hover:bg-yellow-500 transition-colors">黃</button>
                    <button data-filter="E" data-type="category" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">快線</button>
                    <button data-filter="7" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">7</button>
                    <button data-filter="8" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">8</button>
                    <button data-filter="9" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">9</button>

                    <button data-filter="綠" data-type="category" class="p-3 text-black font-bold bg-green-500 rounded-lg shadow-md hover:bg-green-600 transition-colors">綠</button>
                    <button data-filter="小黃" data-type="category" class="bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors bus-taxi-button"><span class="bus-text">公車</span><span class="taxi-text">小黃</span></button>
                    <button data-filter="reset" data-type="action" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">重設</button>
                    <button data-filter="0" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">0</button>
                    <button data-filter="backspace" data-type="action" class="p-3 bg-white text-slate-800 hover:bg-slate-100 rounded-lg shadow-md transition-colors flex justify-center items-center">
                        <span class="material-icons-outlined">backspace</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="busTrackerPage" class="page">
        <div class="container mx-auto p-4 md:p-6 max-w-4xl h-screen flex flex-col">
            
            <div class="flex-shrink-0">
                <header class="flex items-center justify-between mb-4">
                    </header>
                
                <div class="flex items-center justify-center mb-2">
                    <button id="backButton" class="bg-slate-200 hover:bg-slate-300 text-slate-700 p-2 rounded-full transition-colors flex items-center justify-center mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <h1 id="routeTitle" class="text-xl md:text-2xl font-bold text-slate-800 text-center flex-grow"></h1>
                    <div class="w-9 h-9 mr-2"></div> 
                </div>
                <p id="routeDescription" class="text-sm text-slate-500 text-center mb-6"></p>

                <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 text-sm" role="alert">
                    <strong class="font-bold">錯誤!</strong>
                    <span class="block sm:inline" id="errorMessageText"></span>
                </div>

                <div class="direction-toggle-group flex justify-center mb-4 rounded-lg border-2 border-blue-500 overflow-hidden text-sm">
                    <button id="goDirectionButton" class="direction-button flex-1 p-3 font-semibold transition-colors" data-direction="1">去程</button>
                    <button id="backDirectionButton" class="direction-button flex-1 p-3 font-semibold transition-colors" data-direction="2">返程</button>
                </div>
            </div>
            <div id="estimateTimesSection" class="flex-grow overflow-y-auto">
                <div id="trackerLoading" class="text-center py-20 hidden">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="mt-4 text-slate-600 text-sm">正在載入路線動態...</p>
                </div>
                
                <div id="stationList" class="space-y-3">
                    </div>
            </div>
            </div>
    </div>

    <div id="favoriteStationsPage" class="page">
        <div class="container mx-auto p-4 md:p-6 max-w-4xl">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-800">常用站牌</h1>
                <p class="text-slate-500 mt-2">在此管理您常用的公車站牌。</p>
            </header>
            <div id="favoriteListContainer" class="space-y-3">
                <!-- Favorite stations will be rendered here -->
            </div>
            <div id="noFavoritesMessage" class="text-center py-20 text-slate-500 hidden">
                <p>長按或右鍵點擊路線頁面的站牌即可將其加入最愛。</p>
            </div>
        </div>
    </div>

    <div id="settingsPage" class="page">
        <div class="container mx-auto p-4 md:p-6 max-w-4xl">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-800">設定</h1>
                <p class="text-slate-500 mt-2">調整應用程式設定。</p>
            </header>
            <div class="text-center py-20 text-slate-500">
                <p>設定功能即將推出。</p>
            </div>
        </div>
    </div>


    <button id="updateCountdown" style="display:none;">
        <span class="material-icons-outlined">autorenew</span>
        <span id="updateCountdownText">30秒後更新</span>
    </button>

    <!-- Floating button for adding/removing favorites -->
    <button id="favoriteActionButton" class="hidden">
        <span class="material-icons-outlined" id="favoriteActionIcon"></span>
        <span id="favoriteActionText"></span>
    </button>

    <!-- Toast message container -->
    <div id="toastContainer" class="fixed bottom-20 left-1/2 -translate-x-1/2 z-[2000] flex flex-col items-center space-y-2"></div>

    <div id="mainNav">
        <button id="navDynamic" data-page="dynamic" class="active-nav">
            <span class="material-icons-outlined">directions_bus</span>
            <span>動態</span>
        </button>
        <button id="navFavorites" data-page="favorites">
            <span class="material-icons-outlined">favorite</span> <!-- Changed to heart icon -->
            <span>最愛</span> <!-- Changed text to "最愛" -->
        </button>
        <button id="navSettings" data-page="settings">
            <span class="material-icons-outlined">settings</span>
            <span>設定</span>
        </button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- CONFIG & GLOBAL VARS ---
            const API_URL = 'https://ibus.tbkc.gov.tw/ibus/graphql';
            const HEADERS = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            };

            // --- DOM ELEMENTS ---
            const routeSelectionPage = document.getElementById('routeSelectionPage');
            const busTrackerPage = document.getElementById('busTrackerPage');
            const favoriteStationsPage = document.getElementById('favoriteStationsPage');
            const settingsPage = document.getElementById('settingsPage');
            
            const routeSearchInput = document.getElementById('routeSearchInput');
            const categoryDisplay = document.getElementById('categoryDisplay'); // New element for category text
            const routeListContainer = document.getElementById('routeListContainer');
            const initialLoading = document.getElementById('initialLoading');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const filterKeyboard = document.getElementById('filterKeyboard');
            const filterKeyboardContainer = document.getElementById('filterKeyboardContainer');
            
            const backButton = document.getElementById('backButton');
            const trackerLoading = document.getElementById('trackerLoading');
            const routeTitle = document.getElementById('routeTitle');
            const routeDescription = document.getElementById('routeDescription');
            const stationListDiv = document.getElementById('stationList');
            const errorMessageDiv = document.getElementById('errorMessage');
            const errorMessageText = document.getElementById('errorMessageText');
            const goDirectionButton = document.getElementById('goDirectionButton');
            const backDirectionButton = document.getElementById('backDirectionButton');
            const updateCountdownButton = document.getElementById('updateCountdown');
            const mainNav = document.getElementById('mainNav');

            const favoriteListContainer = document.getElementById('favoriteListContainer'); // New
            const noFavoritesMessage = document.getElementById('noFavoritesMessage'); // New
            const favoriteActionButton = document.getElementById('favoriteActionButton'); // New
            const favoriteActionIcon = document.getElementById('favoriteActionIcon'); // New
            const favoriteActionText = document.getElementById('favoriteActionText'); // New
            const toastContainer = document.getElementById('toastContainer'); // New

            // --- STATE ---
            let allRoutes = [];
            let currentRouteData = null;
            let currentDirection = 1; // 1 for Go, 2 for Back
            let currentRouteId = null;
            let currentRouteName = null; // New: Store current route name
            let countdownInterval = null;
            let currentLang = localStorage.getItem("lang") || "zh";
            let activePage = 'dynamic'; // Default active page
            let selectedCategoryPrefix = ''; // New: Store selected category for search

            let favoriteStations = []; // Array to store favorite station objects
            let longPressTimer; // For touch long press detection
            let currentStationContext = null; // Stores data of the station being long-pressed/right-clicked
            let favoriteButtonHideTimeout; // To hide the favorite action button

            const categoryFilters = [
                { prefix: '公車小黃', filterValue: '小黃' },
                { prefix: '紅', filterValue: '紅' },
                { prefix: '橘', filterValue: '橘' },
                { prefix: '黃', filterValue: '黃' },
                { prefix: '綠', filterValue: '綠' },
                { prefix: '其他', filterValue: '其他' },
                { prefix: '幹線', filterValue: '幹線' },
                { prefix: 'E', filterValue: 'E' }
            ];
            
            // New map for display text
            const categoryDisplayMap = {
                '紅': '紅線接駁',
                '橘': '橘線接駁',
                '黃': '黃線接駁',
                '綠': '綠線接駁',
                '幹線': '幹線公車',
                'E': '快線公車',
                '小黃': '公車小黃',
                '其他': '其他路線'
            };


            const GQL = {
                QUERY_SIDE_ROUTES: `query QUERY_SIDE_ROUTES($lang: String!) {
                    routes(lang: $lang) {
                        edges {
                            node {
                                id, opType, id, seq, name, description
                            }
                        }
                    }
                }`,
                QUERY_ROUTE_DETAILS: `query QUERY_ESTIMATE_TIMES($routeId: Int!, $lang: String!) {
                    route(xno: $routeId, lang: $lang) {
                        opType, departure, destination
                        estimateTimes { edges { node { id, goBack, comeTime, etas { busId, etaTime } } } }
                        stations { edges { ivrNo, node { id, name } } }
                    }
                }`
            };

            // --- UTILITY FUNCTIONS ---

            // Fetches data from the GraphQL API
            async function fetchAPI(query, variables) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: HEADERS,
                        body: JSON.stringify({ query, variables })
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error("API Fetch Error:", error);
                    throw error;
                }
            }

            function loadFavorites() {
                try {
                    const favorites = localStorage.getItem('favoriteStations');
                    favoriteStations = favorites ? JSON.parse(favorites) : [];
                } catch (e) {
                    console.error("Error loading favorites from localStorage:", e);
                    favoriteStations = []; // Reset if corrupted
                }
            }

            function saveFavorites() {
                try {
                    localStorage.setItem('favoriteStations', JSON.stringify(favoriteStations));
                } catch (e) {
                    console.error("Error saving favorites to localStorage:", e);
                }
            }

            function isFavorite(routeId, stationId, direction) {
                return favoriteStations.some(fav => fav.routeId === Number(routeId) && fav.stationId === String(stationId) && fav.direction === Number(direction));
            }

            // Toggles a station's favorite status, now including direction
            function toggleFavorite(stationData) {
                // Enforce types when adding to or searching in the array to prevent mismatches.
                const routeId = Number(stationData.routeId);
                const stationId = String(stationData.stationId);
                const direction = Number(stationData.direction);
                const { routeName, stationName, destination } = stationData;

                const index = favoriteStations.findIndex(fav => fav.routeId === routeId && fav.stationId === stationId && fav.direction === direction);

                if (index > -1) {
                    favoriteStations.splice(index, 1);
                } else {
                    favoriteStations.push({ routeId, routeName, stationId, stationName, direction, destination });
                }
                saveFavorites();
                
                // Refresh the bus tracker page to update the heart/dot icon if it's active
                if (busTrackerPage.classList.contains('active') && currentRouteId) {
                    loadBusData(currentRouteId, false);
                }
            }

            // Displays the floating favorite action button
            function showFavoriteButton(stationData, clientX, clientY) {
                clearTimeout(favoriteButtonHideTimeout); // Clear any existing hide timeout

                currentStationContext = stationData; // Store the context
                const { routeId, stationId, direction } = stationData;
                const isCurrentlyFavorite = isFavorite(routeId, stationId, direction);

                favoriteActionIcon.textContent = isCurrentlyFavorite ? 'favorite' : 'favorite_border'; // Changed to heart icons
                favoriteActionText.textContent = isCurrentlyFavorite ? '移除最愛' : '加入最愛';

                favoriteActionButton.classList.remove('hidden');
                favoriteActionButton.classList.add('show');

                // Position the button near the click/long-press location
                const buttonWidth = favoriteActionButton.offsetWidth;
                const buttonHeight = favoriteActionButton.offsetHeight;

                let left = clientX;
                let top = clientY;

                if (left + buttonWidth > window.innerWidth - 10) left = window.innerWidth - buttonWidth - 10;
                if (top + buttonHeight > window.innerHeight - 10) top = window.innerHeight - buttonHeight - 10;
                if (left < 10) left = 10;
                if (top < 10) top = 10;

                favoriteActionButton.style.left = `${left}px`;
                favoriteActionButton.style.top = `${top}px`;

                // Hide the button after a few seconds if not interacted with
                favoriteButtonHideTimeout = setTimeout(() => {
                    favoriteActionButton.classList.remove('show');
                    favoriteActionButton.addEventListener('transitionend', () => {
                        favoriteActionButton.classList.add('hidden');
                    }, { once: true });
                }, 3000); // Hide after 3 seconds
            }

            // Hides the floating favorite action button
            function hideFavoriteButton() {
                clearTimeout(favoriteButtonHideTimeout);
                favoriteActionButton.classList.remove('show');
                favoriteActionButton.addEventListener('transitionend', () => {
                    favoriteActionButton.classList.add('hidden');
                }, { once: true });
            }

            // Event listener for the floating favorite button click
            favoriteActionButton.addEventListener('click', () => {
                if (currentStationContext) {
                    toggleFavorite(currentStationContext);
                    hideFavoriteButton(); // Hide after action
                }
            });

            // --- PAGE MANAGEMENT ---

            // Shows the specified page and manages keyboard/countdown visibility
            function showPage(pageId) {
                const pages = document.querySelectorAll('.page');
                pages.forEach(page => page.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');

                // Adjust visibility of keyboard and countdown based on page
                if (pageId === 'routeSelectionPage') {
                    filterKeyboardContainer.style.display = 'block';
                    updateCountdownButton.style.display = 'none';
                    adjustContentPadding(); // Adjust padding when keyboard is visible
                } else if (pageId === 'busTrackerPage') {
                    filterKeyboardContainer.style.display = 'none'; // Hide keyboard on tracker page
                    if (navigator.onLine) {
                        updateCountdownButton.style.display = 'flex';
                    } else {
                        updateCountdownButton.style.display = 'none';
                    }
                    // Reset padding if it was adjusted for keyboard
                    const routeSelectionContainer = document.querySelector('#routeSelectionPage .container');
                    if (routeSelectionContainer) {
                        routeSelectionContainer.style.paddingBottom = ''; // Clear inline style
                    }
                } else {
                    filterKeyboardContainer.style.display = 'none';
                    updateCountdownButton.style.display = 'none';
                    // Reset padding if it was adjusted for keyboard
                    const routeSelectionContainer = document.querySelector('#routeSelectionPage .container');
                    if (routeSelectionContainer) {
                        routeSelectionContainer.style.paddingBottom = ''; // Clear inline style
                    }
                }

                // Update active navigation button
                document.querySelectorAll('#mainNav button').forEach(button => {
                    button.classList.remove('active-nav');
                });
                const navButtonId = pageId === 'routeSelectionPage' || pageId === 'busTrackerPage' ? 'dynamic' : pageId.replace('Page', '');
                const navButton = document.querySelector(`#mainNav button[data-page="${navButtonId}"]`);
                if (navButton) {
                    navButton.classList.add('active-nav');
                }
                activePage = navButtonId;

                // If navigating to favorites page, refresh its content
                if (pageId === 'favoriteStationsPage') {
                    displayFavoriteStations();
                }
            }

            // --- PAGE 1: ROUTE SELECTION ---

            // Initializes the route selection page by fetching all routes
            async function initRouteSelection() {
                try {
                    const data = await fetchAPI(GQL.QUERY_SIDE_ROUTES, { lang: "zh" });
                    allRoutes = data.data.routes.edges
                        .map(edge => edge.node)
                        .filter(route => route.id !== 0)
                        .sort((a, b) => a.seq - b.seq);
                    
                    initialLoading.style.display = 'none';
                    displayInitialPrompt(); // Always display initial prompt if no route in URL
                } catch (error) {
                    initialLoading.innerHTML = '<p class="text-red-500">無法載入路線列表，請重新整理頁面。</p>';
                }
            }

            // Displays the initial prompt in the route list area
            function displayInitialPrompt() {
                routeListContainer.innerHTML = `
                    <div id="initialPrompt" class="text-center col-span-full py-10 text-slate-500">
                        <p class="text-lg">請使用鍵盤或直接輸入開始搜尋路線。</p>
                    </div>`;
                noResultsMessage.style.display = 'none';
            }

            // Displays filtered routes in cards
            function displayRoutes(routes) {
                routeListContainer.innerHTML = '';
                if (routes.length === 0) {
                    noResultsMessage.style.display = 'block';
                } else {
                    noResultsMessage.style.display = 'none';
                }
                
                routes.forEach(route => {
                    const card = document.createElement('div');
                    card.className = 'route-card p-4 bg-white rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer border-l-4 border-transparent hover:border-blue-500';
                    card.dataset.routeId = route.id;
                    card.dataset.routeName = route.name;
                    card.dataset.routeDesc = route.description;
                    
                    card.innerHTML = `
                        <h3 class="font-bold text-lg text-slate-800">${route.name}</h3>
                        <p class="text-sm text-slate-500">${route.description}</p>
                    `;
                    card.addEventListener('click', () => {
                        navigateToTracker(card.dataset.routeId, card.dataset.routeName, card.dataset.routeDesc, true);
                    });
                    routeListContainer.appendChild(card);
                });
            }

            // Applies search filter to routes based on input (NO CHANGE TO THIS FUNCTION'S LOGIC)
            function applySearch(searchTerm) {
                const lowerCaseTerm = searchTerm.toLowerCase().trim();
                
                if (!lowerCaseTerm) {
                    displayInitialPrompt();
                    return;
                }

                let filteredRoutes = [...allRoutes];

                // This logic remains the same, it checks if the combined search term starts with a category prefix
                let categoryMatched = false;
                let remainingSearchTerm = lowerCaseTerm;

                for (const category of categoryFilters) {
                    const lowerCasePrefix = category.prefix.toLowerCase();
                    if (lowerCaseTerm.startsWith(lowerCasePrefix)) {
                        if (category.filterValue === '其他') {
                            filteredRoutes = filteredRoutes.filter(route =>
                                route.name.toLowerCase().includes('joy') ||
                                route.name.toLowerCase().includes('大樹祈福線')
                            );
                        } else if (category.filterValue === 'E') {
                            filteredRoutes = filteredRoutes.filter(route =>
                                route.name.toLowerCase().startsWith('e')
                            );
                        } else if (category.filterValue === '小黃') {
                            // MODIFIED: Filter by opType === 9 for "公車小黃"
                            filteredRoutes = filteredRoutes.filter(route =>
                                route.opType === 9
                            );
                        } else if (category.filterValue === '黃') {
                            filteredRoutes = filteredRoutes.filter(route =>
                                route.name.toLowerCase().includes('黃') && route.opType !== 9 // Exclude opType 9 from "黃" category
                            );
                        } else {
                            filteredRoutes = filteredRoutes.filter(route =>
                                route.name.toLowerCase().includes(category.filterValue.toLowerCase())
                            );
                        }

                        remainingSearchTerm = lowerCasePrefix.length > 0 ? lowerCaseTerm.substring(lowerCasePrefix.length).trim() : lowerCaseTerm;
                        categoryMatched = true;
                        break;
                    }
                }

                if (remainingSearchTerm) {
                    filteredRoutes = filteredRoutes.filter(route =>
                        route.name.toLowerCase().includes(remainingSearchTerm)
                    );
                }
                
                displayRoutes(filteredRoutes);
            }

            // --- START: MODIFIED Keyboard input handling ---
            filterKeyboard.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const value = button.dataset.filter;
                const type = button.dataset.type;

                if (type === 'category') {
                    // Define the search prefix based on the button clicked. This is used for filtering.
                    let searchPrefix;
                    if (value === '小黃') {
                        searchPrefix = '公車小黃';
                    } else if (value === 'E') {
                        searchPrefix = '快線';
                    } else {
                        searchPrefix = button.textContent;
                    }

                    selectedCategoryPrefix = searchPrefix;
                    // Update the blue display text using the map
                    categoryDisplay.textContent = categoryDisplayMap[value] || '全部路線';
                    routeSearchInput.value = ''; // Reset number input when category changes

                } else if (type === 'number') {
                    routeSearchInput.value += value;

                } else if (type === 'action') {
                    if (value === 'reset') {
                        selectedCategoryPrefix = '';
                        routeSearchInput.value = '';
                        categoryDisplay.textContent = '全部路線'; // Reset display text
                    } else if (value === 'backspace') {
                        routeSearchInput.value = routeSearchInput.value.slice(0, -1);
                    }
                }
                
                // On every keypress, construct the full search term and call applySearch
                const fullSearchTerm = selectedCategoryPrefix + routeSearchInput.value;
                applySearch(fullSearchTerm);
            });

            // Add touchend event listener to release active state on touch devices
            filterKeyboard.addEventListener('touchend', (e) => {
                const button = e.target.closest('button');
                if (button) {
                    // This forces the browser to re-evaluate the :active state,
                    // effectively releasing it on touchend.
                    button.blur(); 
                }
            });
            // --- END: MODIFIED Keyboard input handling ---
            
            // The old 'input' event listener on routeSearchInput is no longer needed as it's readonly and controlled by the keyboard.

            // --- PAGE 2: BUS TRACKER ---

            // Updates direction buttons text and active state
            function updateDirectionButtons() {
                if (!currentRouteData) return;

                goDirectionButton.textContent = `往 ${currentRouteData.destination}`;
                backDirectionButton.textContent = `往 ${currentRouteData.departure}`;

                if (currentDirection === 1) {
                    goDirectionButton.classList.add('bg-blue-500', 'text-white');
                    goDirectionButton.classList.remove('bg-white', 'text-blue-500');
                    backDirectionButton.classList.add('bg-white', 'text-blue-500');
                    backDirectionButton.classList.remove('bg-blue-500', 'text-white');
                } else {
                    backDirectionButton.classList.add('bg-blue-500', 'text-white');
                    backDirectionButton.classList.remove('bg-white', 'text-blue-500');
                    goDirectionButton.classList.add('bg-white', 'text-blue-500');
                    goDirectionButton.classList.remove('bg-blue-500', 'text-white');
                }
            }
            
            // Handles direction toggle button clicks
            function handleDirectionToggle(event) {
                const newDirection = parseInt(event.currentTarget.dataset.direction);
                if (newDirection !== currentDirection) {
                    currentDirection = newDirection;
                    updateDirectionButtons();
                    if (currentRouteData) {
                        displayEstimateTimes(currentRouteData, currentDirection);
                    }
                }
            }

            // Helper function to create a station card element
            function createStationCard(estimate, stationName, displayedBusIds) {
                let timeDisplay = '<span class="text-slate-400">末班駛離</span>';
                let busIdDisplayHtml = ''; // Changed variable name to avoid confusion with the element
                let timeColorClass = 'text-slate-500';
                let pillBgColorClass = 'bg-slate-200';

                if (estimate.etas && estimate.etas.length > 0) {
                    const closestEta = estimate.etas.reduce((minEta, currentEta) => {
                        const minTime = minEta.etaTime !== null ? minEta.etaTime : Infinity;
                        const currentTime = currentEta.etaTime !== null ? currentEta.etaTime : Infinity;
                        return currentTime < minTime ? currentEta : minEta;
                    }, { etaTime: Infinity });

                    if (closestEta.etaTime !== Infinity && closestEta.etaTime !== null) {
                        if (closestEta.etaTime <= 1) {
                            timeDisplay = '進站中';
                            timeColorClass = 'text-red-700';
                            pillBgColorClass = 'bg-red-200';
                        } else if (closestEta.etaTime <= 3) {
                            timeDisplay = '即將到站';
                            timeColorClass = 'text-green-700';
                            pillBgColorClass = 'bg-green-200';
                        } else {
                            timeDisplay = `${closestEta.etaTime}分`;
                            timeColorClass = 'text-blue-700';
                            pillBgColorClass = 'bg-blue-200';
                        }

                        // Only display busId if it exists and hasn't been displayed for this station already
                        if (closestEta.busId && !displayedBusIds.has(closestEta.busId)) {
                            busIdDisplayHtml = `<div class="bus-id-display">
                                                    <span class="material-icons-outlined text-sm">directions_bus</span>
                                                    <span>${closestEta.busId}</span>
                                                </div>`;
                            displayedBusIds.add(closestEta.busId);
                        }
                    }
                } else if (estimate.comeTime) {
                    timeDisplay = estimate.comeTime;
                    timeColorClass = 'text-slate-700';
                    pillBgColorClass = 'bg-slate-200';
                }

                const stationCard = document.createElement('div');
                stationCard.className = 'station-item';
                stationCard.dataset.stationId = estimate.id;
                stationCard.dataset.stationName = stationName;
                stationCard.dataset.routeId = currentRouteId;
                stationCard.dataset.routeName = currentRouteName;

                const isCurrentlyFavorite = isFavorite(currentRouteId, estimate.id, currentDirection);
                const iconHtml = isCurrentlyFavorite 
                    ? '<span class="material-icons-outlined text-red-500">favorite</span>' 
                    : '<div class="station-dot"></div>';

                stationCard.innerHTML = `
                    <div class="station-icon-container">
                        ${iconHtml}
                    </div>
                    <div class="station-content">
                        <div class="time-pill ${pillBgColorClass}">
                            <p class="text-base font-bold ${timeColorClass}">${timeDisplay}</p>
                        </div>
                        <div class="station-name">
                            <p class="text-base font-medium text-slate-800">${stationName}</p>
                        </div>
                        ${busIdDisplayHtml} <!-- Insert the bus ID display here -->
                    </div>
                `;

                // Add event listeners for right click
                stationCard.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    const stationData = {
                        routeId: parseInt(e.currentTarget.dataset.routeId),
                        routeName: e.currentTarget.dataset.routeName,
                        stationId: e.currentTarget.dataset.stationId,
                        stationName: e.currentTarget.dataset.stationName,
                        direction: currentDirection,
                        destination: currentDirection === 1 ? currentRouteData.destination : currentRouteData.departure
                    };
                    showFavoriteButton(stationData, e.clientX, e.clientY);
                });

                // --- START: Improved Touch Event Listeners ---
                let touchStartX, touchStartY;
                let longPressTimer;
                let isLongPress = false; // Flag to indicate if a long press has been detected and handled

                stationCard.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 1) {
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                        isLongPress = false; // Reset flag for new touch

                        longPressTimer = setTimeout(() => {
                            isLongPress = true; // Mark as long press
                            // Prevent default context menu, but only if it's a long press
                            // This prevents both the context menu and potential scrolling if held long enough
                            e.preventDefault(); 
                            const stationData = {
                                routeId: parseInt(e.currentTarget.dataset.routeId),
                                routeName: e.currentTarget.dataset.routeName,
                                stationId: e.currentTarget.dataset.stationId,
                                stationName: e.currentTarget.dataset.stationName,
                                direction: currentDirection,
                                destination: currentDirection === 1 ? currentRouteData.destination : currentRouteData.departure
                            };
                            showFavoriteButton(stationData, e.touches[0].clientX, e.touches[0].clientY);
                        }, 700); // 700ms for long press
                    }
                });

                stationCard.addEventListener('touchmove', (e) => {
                    if (!longPressTimer) return; // If timer already cleared or not set, ignore

                    const deltaX = Math.abs(e.touches[0].clientX - touchStartX);
                    const deltaY = Math.abs(e.touches[0].clientY - touchStartY);

                    // If moved more than a 10px threshold, it's a scroll, cancel long press
                    if (deltaX > 10 || deltaY > 10) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null; // Clear timer reference
                        isLongPress = false; // It's not a long press
                    }
                });

                stationCard.addEventListener('touchend', (e) => {
                    if (longPressTimer) { // If timer is still active (not cleared by touchmove)
                        clearTimeout(longPressTimer);
                        longPressTimer = null; // Clear timer reference
                    }
                    // If it was a long press, the action has already been taken (showFavoriteButton).
                    // If it was a short tap, no default action is defined for station cards, so nothing happens.
                    // No need to call e.preventDefault() here unless we want to prevent a click.
                });

                stationCard.addEventListener('touchcancel', (e) => {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    isLongPress = false;
                });
                // --- END: Improved Touch Event Listeners ---

                return stationCard;
            }

            // Displays estimated arrival times for stations
            function displayEstimateTimes(data, direction) {
                errorMessageDiv.style.display = 'none';

                const stationMap = new Map(data.stations.edges.map(edge => [edge.node.id, edge.node.name]));
                const filteredEstimates = data.estimateTimes.edges.filter(edge => edge.node.goBack === direction);

                if (!data || !data.estimateTimes || !data.estimateTimes.edges.length || filteredEstimates.length === 0) {
                    stationListDiv.innerHTML = `<p class="text-center py-4 text-slate-500 text-sm">此方向目前沒有班次資訊。</p>`;
                    return;
                }

                const fragment = document.createDocumentFragment();
                const displayedBusIds = new Set();

                filteredEstimates.forEach(({ node: estimate }) => {
                    const stationName = stationMap.get(estimate.id) || `未知站點 (ID: ${estimate.id})`;
                    const card = createStationCard(estimate, stationName, displayedBusIds);
                    fragment.appendChild(card);
                });

                stationListDiv.innerHTML = ''; // Clear previous content
                stationListDiv.appendChild(fragment);
            }
            
            // Loads bus data for a specific route
            async function loadBusData(routeId, isInitialLoad = false, scrollToStationId = null) {
                if (isInitialLoad) trackerLoading.style.display = 'block';
                errorMessageDiv.style.display = 'none';
                updateCountdownButton.disabled = true;

                try {
                    const result = await fetchAPI(GQL.QUERY_ROUTE_DETAILS, { routeId: parseInt(routeId), lang: "zh" });
                    
                    if (!result.data.route) throw new Error("找不到該路線的資訊，請確認路線代號是否正確。");
                    
                    currentRouteData = result.data.route;
                    updateDirectionButtons();
                    displayEstimateTimes(currentRouteData, currentDirection);

                    if (scrollToStationId) {
                        await new Promise(resolve => setTimeout(resolve, 0)); 
                        const targetStationCard = document.querySelector(`[data-station-id="${scrollToStationId}"]`);
                        if (targetStationCard) {
                            targetStationCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                } catch (error) {
                    errorMessageText.textContent = error.message;
                    errorMessageDiv.style.display = 'block';
                } finally {
                    trackerLoading.style.display = 'none';
                    updateCountdownButton.disabled = false;
                }
            }

            // Navigates to the bus tracker page
            function navigateToTracker(routeId, routeName, routeDesc, pushState = true, scrollToStationId = null, direction = 1) {
                currentRouteId = routeId;
                currentRouteName = routeName;
                currentDirection = direction; // Set direction
                
                showPage('busTrackerPage');
                const url = `${window.location.pathname}?route=${routeId}`;
                const state = { page: 'tracker', routeId: routeId, stationId: scrollToStationId, direction: direction };
                if (pushState) {
                    history.pushState(state, '', url);
                } else {
                    history.replaceState(state, '', url);
                }

                routeTitle.textContent = routeName;
                routeDescription.textContent = ''; 
                
                loadBusData(currentRouteId, true, scrollToStationId);
                countdownTimer.reset();
            }

            // Navigates back to the route selection page
            function navigateToSelection() {
                showPage('routeSelectionPage');
                currentRouteData = null;
                currentRouteId = null;
                currentRouteName = null;
                // 重置搜尋狀態
                routeSearchInput.value = ''; 
                selectedCategoryPrefix = '';
                categoryDisplay.textContent = '全部路線';
                applySearch(''); // Clear search results and show initial prompt
                history.pushState({ page: 'selection' }, '', window.location.pathname);
                clearInterval(countdownInterval);
                hideFavoriteButton();
            }

            // --- PAGE 3: FAVORITE STATIONS ---

            // Displays the list of favorite stations
            function displayFavoriteStations() {
                loadFavorites();
                favoriteListContainer.innerHTML = '';

                if (favoriteStations.length === 0) {
                    noFavoritesMessage.classList.remove('hidden');
                } else {
                    noFavoritesMessage.classList.add('hidden');
                    favoriteStations.forEach(fav => {
                        const favCard = document.createElement('div');
                        favCard.className = 'favorite-card-item flex items-center justify-between p-4 bg-white rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer';
                        
                        const directionText = fav.destination ? `往 ${fav.destination}` : `方向 ${fav.direction}`;

                        favCard.innerHTML = `
                            <div class="flex-grow">
                                <h3 class="font-bold text-lg text-slate-800">${fav.routeName} - ${fav.stationName}</h3>
                                <p class="text-sm text-slate-500">${directionText}</p>
                            </div>
                            <button class="remove-favorite-btn flex-shrink-0 bg-red-100 text-red-600 p-2 rounded-full hover:bg-red-200 transition-colors ml-4"
                                data-route-id="${fav.routeId}" data-station-id="${fav.stationId}" data-direction="${fav.direction}">
                                <span class="material-icons-outlined">delete</span>
                            </button>
                        `;

                        // Navigate on card click, but not on button click
                        favCard.addEventListener('click', (e) => {
                            if (!e.target.closest('.remove-favorite-btn')) {
                                navigateToTracker(fav.routeId, fav.routeName, '', true, fav.stationId, fav.direction);
                            }
                        });
                        favoriteListContainer.appendChild(favCard);
                    });

                    // Add event listeners for remove buttons
                    favoriteListContainer.querySelectorAll('.remove-favorite-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const cardToRemove = e.currentTarget.closest('.favorite-card-item');
                            const stationData = {
                                routeId: parseInt(e.currentTarget.dataset.routeId),
                                stationId: e.currentTarget.dataset.stationId,
                                direction: parseInt(e.currentTarget.dataset.direction)
                            };
                            
                            toggleFavorite(stationData); // Update data model

                            if (cardToRemove) cardToRemove.remove(); // Instantly remove from DOM
                            
                            if (favoriteListContainer.childElementCount === 0) {
                                noFavoritesMessage.classList.remove('hidden');
                            }
                        });
                    });
                }
            }

            // --- Update Countdown Logic ---
            let countdownTimer = {
                remaining: 30,
                updateButton: document.getElementById('updateCountdown'),
                updateDisplay: function() {
                    const text = `${this.remaining}秒後更新`;
                    document.getElementById('updateCountdownText').textContent = text;
                },
                reset: function() {
                    const icon = this.updateButton.querySelector('.material-icons-outlined');
                    icon.classList.add('spin-update');
                    setTimeout(() => icon.classList.remove('spin-update'), 500);
                    this.remaining = 30;
                    this.updateDisplay();
                },
                update: async function() {
                    const icon = this.updateButton.querySelector('.material-icons-outlined');
                    icon.classList.add('spin-update');
                    setTimeout(() => icon.classList.remove('spin-update'), 500);

                    if (currentRouteId) {
                        await loadBusData(currentRouteId, false);
                    }
                    this.reset();
                }
            };

            // Function to calculate and apply padding for fixed keyboard and nav
            function adjustContentPadding() {
                const mainNavHeight = mainNav.offsetHeight;
                // Temporarily show the keyboard to measure its height accurately
                filterKeyboardContainer.style.display = 'block';
                const keyboardHeight = filterKeyboardContainer.offsetHeight;
                // If the current page is not route selection, hide it again
                if (!routeSelectionPage.classList.contains('active')) {
                    filterKeyboardContainer.style.display = 'none'; 
                }

                // Calculate total height needed for padding, add a small buffer
                const totalFixedBottomHeight = mainNavHeight + keyboardHeight + 10; // 10px buffer

                // Apply padding to the main content container of the route selection page
                // This ensures content can scroll above the fixed keyboard and nav
                const routeSelectionContainer = document.querySelector('#routeSelectionPage .container');
                if (routeSelectionContainer) {
                    routeSelectionContainer.style.paddingBottom = `${totalFixedBottomHeight}px`;
                }
            }

            // --- Event Listeners ---
            backButton.addEventListener('click', navigateToSelection);
            goDirectionButton.addEventListener('click', handleDirectionToggle);
            backDirectionButton.addEventListener('click', handleDirectionToggle);
            
            window.addEventListener('popstate', (event) => {
                const state = event.state || {};
                const urlParams = new URLSearchParams(window.location.search);
                const routeIdFromUrl = urlParams.get('route');
                const pageFromUrl = urlParams.get('page');
                const stationIdFromState = state.stationId;
                const directionFromState = state.direction;

                if (routeIdFromUrl) {
                    const route = allRoutes.find(r => r.id.toString() === routeIdFromUrl);
                    if (route) {
                        navigateToTracker(route.id, route.name, route.description, false, stationIdFromState, directionFromState);
                    } else {
                        navigateToSelection();
                    }
                } else if (pageFromUrl === 'favorites') {
                    showPage('favoriteStationsPage');
                } else if (pageFromUrl === 'settings') {
                    showPage('settingsPage');
                } else {
                    navigateToSelection();
                }
            });

            updateCountdownButton.addEventListener('click', () => {
                countdownTimer.update();
            });

            // Main Navigation Event Listener
            mainNav.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const page = button.dataset.page;
                if (page === 'dynamic') {
                    // Always go to selection page from nav
                    navigateToSelection();
                } else if (page === 'favorites') {
                    showPage('favoriteStationsPage');
                    history.pushState({ page: 'favorites' }, '', `${window.location.pathname}?page=favorites`);
                } else if (page === 'settings') {
                    showPage('settingsPage');
                    history.pushState({ page: 'settings' }, '', `${window.location.pathname}?page=settings`);
                }
            });

            // Global click listener to hide the favorite action button if clicked outside
            document.addEventListener('click', (e) => {
                if (!favoriteActionButton.contains(e.target) && favoriteActionButton.classList.contains('show')) {
                    hideFavoriteButton();
                }
            });

            // --- Initial Load Logic ---
            loadFavorites(); // Load favorites on app start
            await initRouteSelection(); // Always init routes first

            // Call on initial load to set correct padding
            adjustContentPadding();
            // Call on window resize to adjust for orientation changes or dynamic keyboard height
            window.addEventListener('resize', adjustContentPadding);


            const urlParams = new URLSearchParams(window.location.search);
            const routeIdFromUrl = urlParams.get('route');
            const pageFromUrl = urlParams.get('page');

            if (routeIdFromUrl) {
                const route = allRoutes.find(r => r.id.toString() === routeIdFromUrl);
                if (route) {
                    // For direct URL load, default to direction 1
                    navigateToTracker(route.id, route.name, route.description, false, null, 1);
                } else {
                    showPage('routeSelectionPage');
                    history.replaceState({ page: 'selection' }, '', window.location.pathname);
                }
            } else if (pageFromUrl) {
                if (pageFromUrl === 'favorites') {
                    showPage('favoriteStationsPage');
                } else if (pageFromUrl === 'settings') {
                    showPage('settingsPage');
                } else {
                    showPage('routeSelectionPage');
                }
            } else {
                showPage('routeSelectionPage');
            }

            // Start countdown interval
            countdownInterval = setInterval(() => {
                if (busTrackerPage.classList.contains('active') && navigator.onLine) {
                    updateCountdownButton.style.display = "flex";
                    countdownTimer.remaining--;
                    if (countdownTimer.remaining <= 0) {
                        countdownTimer.update();
                    }
                    countdownTimer.updateDisplay();
                } else {
                    updateCountdownButton.style.display = "none";
                }
            }, 1000);

            window.addEventListener('online', () => {
                if (busTrackerPage.classList.contains('active')) {
                    updateCountdownButton.style.display = "flex";
                    countdownTimer.update();
                }
            });

            window.addEventListener('offline', () => {
                updateCountdownButton.style.display = "none";
            });

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && navigator.onLine && busTrackerPage.classList.contains('active')) {
                    console.log('Tab 變為可見，更新數據...');
                    countdownTimer.update();
                }
            });
        });
    </script>
</body>
</html>
