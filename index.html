<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="ahdkishmook7wgZXJ6JVA43nNO5SSccNOlvmB575Od4" />
    <title>高雄市公車動態查詢器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Optimized Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
            user-select: none; /* 鎖定文字選取 */
            -webkit-user-select: none; /* For Safari */
            -moz-user-select: none; /* For Firefox */
            -ms-user-select: none; /* For Internet Explorer/Edge */
            transition: background-color 0.3s ease, color 0.3s ease; /* Dark mode transition */
        }
        /* Loading Spinner Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1.2s linear infinite;
        }
        /* Page transition styles */
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }

        /* Animation for direction change */
        #estimateTimesSection {
            position: relative;
            overflow: hidden;
        }
        @keyframes slide-out-left {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-100%); opacity: 0; }
        }
        @keyframes slide-in-from-right {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slide-out-right {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        @keyframes slide-in-from-left {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .slide-out-left { animation: slide-out-left 0.3s ease-out forwards; }
        .slide-in-from-right { animation: slide-in-from-right 0.3s ease-in forwards; }
        .slide-out-right { animation: slide-out-right 0.3s ease-out forwards; }
        .slide-in-from-left { animation: slide-in-from-left 0.3s ease-in forwards; }

        /* Custom scrollbar - Hidden but scrollable */
        ::-webkit-scrollbar {
            width: 0px; /* For vertical scrollbar */
            height: 0px; /* For horizontal scrollbar */
        }
        ::-webkit-scrollbar-track {
            background: transparent; /* Make track transparent */
        }
        ::-webkit-scrollbar-thumb {
            background: transparent; /* Make thumb transparent */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: transparent; /* Make thumb transparent on hover */
        }
        /* Updated Material Icons class name */
        .material-icons-outlined {
            font-size: 24px;
        }
        /* Ensure the body has enough padding at the bottom for the fixed keyboard */
        /* This will be set dynamically by JavaScript */
        #routeSelectionPage .container, #mrtPage .container, #homePage .container {
            padding-bottom: 90px;
        }
        @media (min-width: 768px) {
            #routeSelectionPage .container, #mrtPage .container, #homePage .container {
                padding-bottom: 100px;
            }
        }

        /* For "公車小黃" button to wrap text on narrow screens */
        .bus-taxi-button {
            line-height: 1.2;
            white-space: normal;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 0.4rem 0.2rem;
        }

        /* Force line break for "公車" and "小黃" on narrow screens */
        .bus-taxi-button .bus-text,
        .bus-taxi-button .taxi-text {
            display: block;
        }

        @media (min-width: 768px) {
            .bus-taxi-button {
                padding: 0.75rem;
                flex-direction: row;
                white-space: nowrap;
            }
            .bus-taxi-button .bus-text,
            .bus-taxi-button .taxi-text {
                display: inline;
            }
        }

        /* Styles for the new update countdown button */
        #updateCountdown {
            white-space: nowrap;
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            padding: 8px 16px;
            background-color: #e0f2fe; /* Light blue */
            color: #333;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            width: auto;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
        }

        #updateCountdown:hover {
            background-color: #bfdbfe;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }

        #updateCountdown .material-icons-outlined {
            font-size: 18px;
            vertical-align: middle;
        }

        @keyframes spin-180 {
            from { transform: rotate(0deg); }
            to { transform: rotate(180deg); }
        }

        .spin-update {
            animation: spin-180 0.5s ease forwards;
        }

        /* Styles for the keyboard to make buttons square on narrow screens */
        @media (max-width: 767px) {
            #filterKeyboard {
                gap: 4px !important;
                max-width: 384px;
                margin-left: auto;
                margin-right: auto;
            }

            #filterKeyboard > button {
                aspect-ratio: 1 / 1;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #filterKeyboard .bus-taxi-button {
                padding: 4px;
                line-height: 1.1;
            }
        }

        /* Styles for the main navigation bar */
        #mainNav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border-top: 1px solid #e2e8f0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
        }
        #mainNav button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            padding: 4px 4px;
            font-size: 0.8rem;
            color: #64748b;
            background-color: transparent;
            border: none;
            cursor: pointer;
            transition: color 0.2s, background-color 0.2s;
        }
        #mainNav button .material-icons-outlined {
            font-size: 28px;
            margin-bottom: 4px;
        }
        #mainNav button:hover {
            color: #3b82f6;
        }
        #mainNav button.active-nav {
            color: #3b82f6;
            font-weight: 600;
        }

        /* Styles for the floating favorite button */
        #favoriteActionButton {
            position: fixed;
            padding: 8px 16px;
            background-color: #1d4ed8;
            color: white;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            font-size: 0.9em;
            cursor: pointer;
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.2s;
            transform: translateY(10px);
        }
        #favoriteActionButton.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        #favoriteActionButton:hover {
            background-color: #2563eb;
        }

        /* Styles for toast messages */
        .toast-message {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        .toast-message.show {
            opacity: 1;
        }

        /* Styles for the station list in bus tracker page */
        .station-list-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            scroll-padding-top: 1rem;
        }

        #stationListGoContent, #stationListBackContent {
            position: relative;
            padding-left: 20px;
            padding-bottom: 90px; /* Increased padding to ensure the last item is not obscured by the bottom nav bar */
        }

        #stationListGoContent::before, #stationListBackContent::before {
            content: '';
            position: absolute;
            left: 21px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #cbd5e1;
            z-index: 0;
        }

        body.dark-mode #stationListGoContent::before,
        body.dark-mode #stationListBackContent::before {
             background-color: #475569;
        }

        .station-item {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .station-item:last-child {
            margin-bottom: 0;
        }

        .station-icon-container {
            position: absolute;
            left: -18px; /* Corrected from -19px for proper alignment */
            z-index: 1;
            background-color: #f1f5f9;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        body.dark-mode .station-icon-container {
            background-color: #0f172a;
        }

        .station-dot {
            width: 12px;
            height: 12px;
            background-color: #3b82f6;
            border-radius: 50%;
        }

        .station-content {
            flex: 1;
            padding: 12px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-left: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        body.dark-mode .station-content {
            background-color: #1e293b;
        }

        .station-content .time-pill, .favorite-time-display .time-pill {
            flex-shrink: 0;
            min-width: 90px;
            text-align: center;
            padding: 6px 8px;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 0.9em;
        }

        /* Unified time pill colors for light mode */
        .time-pill.bg-slate-200 { background-color: #e2e8f0; color: #1e293b; } /* Default/Unknown */
        .time-pill.bg-red-200 { background-color: #fee2e2; color: #b91c1c; } /* 進站中 */
        .time-pill.bg-green-200 { background-color: #dcfce7; color: #166534; } /* 即將到站 */
        .time-pill.bg-blue-200 { background-color: #dbeafe; color: #1e40af; } /* N 分 */
        .favorite-time-display .time-pill.bg-yellow-200 { background-color: #fef9c3; color: #854d0e; } /* Favorites "即將到站" */


        .station-content .station-name {
            flex-grow: 1;
            font-weight: 500;
            color: #1e293b;
        }

        body.dark-mode .station-content .station-name {
            color: #e2e8f0;
        }

        .station-content .bus-id-display {
            flex-shrink: 0;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background-color: #dbeafe;
            color: #1e40af;
            font-size: 0.75em;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 9999px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        body.dark-mode .bus-id-display {
            background-color: #1e3a8a;
            color: #bfdbfe;
        }

        /* --- START: FAVORITES PAGE DRAG STYLES --- */
        #favoriteListContainer .favorite-card-item {
            position: relative;
            touch-action: pan-y; /* Allow vertical scroll */
        }
        #favoriteListContainer .favorite-card-item.dragging {
            opacity: 0.4;
            background: #e0f2fe;
            border: 2px dashed #3b82f6;
        }

        .favorite-card-content {
            position: relative;
            display: flex;
            align-items: center;
            padding: 0.75rem; /* 12px */
            background-color: #ffffff;
            transition: transform 0.3s ease-out;
            width: 100%;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        .drag-handle {
            cursor: move;
            cursor: grab;
            padding: 8px;
            color: #94a3b8;
            touch-action: none; /* Prevent scrolling when dragging handle */
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        /* --- END: FAVORITES PAGE DRAG STYLES --- */

        /* --- START: HOME(WEATHER) PAGE STYLES --- */
        #homePage .weather-card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            max-width: 500px;
            width: 100%;
            text-align: center;
            border: 1px solid #bfdbfe;
        }
        body.dark-mode #homePage .weather-card {
            background-color: #1e293b; /* slate-800 */
            border-color: #334155; /* slate-700 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        #homePage .weather-card h2 {
            color: #334155;
        }
        body.dark-mode #homePage .weather-card h2 {
            color: #e2e8f0; /* slate-200 */
        }
        #homePage .weather-card p {
            color: #64748b;
        }
        body.dark-mode #homePage .weather-card p {
            color: #cbd5e1; /* slate-300 */
        }
        #homePage .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        #homePage .weather-detail-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        #homePage .detail-item {
            background-color: #f8fafc;
            padding: 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            font-size: 0.875rem;
        }
        body.dark-mode #homePage .weather-detail-grid .detail-item {
            background-color: #0f172a; /* slate-900 */
            border-color: #334155; /* slate-700 */
        }
        #homePage .detail-label {
            font-weight: 600;
            color: #4a5568;
        }
        body.dark-mode #homePage .detail-label {
            color: #94a3b8; /* slate-400 */
        }
        #homePage .detail-value {
            color: #2d3748;
            margin-top: 0.25rem;
        }
        body.dark-mode #homePage .detail-value {
            color: #e2e8f0; /* slate-200 */
        }
        #homePage #temperature {
            color: #1e3a8a; /* blue-800 */
        }
        body.dark-mode #homePage #temperature {
            color: #93c5fd; /* blue-300 */
        }
        #homePage #weather-description {
            color: #4b5563; /* gray-700 */
        }
        body.dark-mode #homePage #weather-description {
            color: #cbd5e1; /* slate-300 */
        }
        body.dark-mode #homePage #error-message {
            color: #f87171; /* red-400 */
        }
        /* --- END: HOME(WEATHER) PAGE STYLES --- */

        /* Styles for the shared outer frame for weather and announcements */
        .weather-announcement-frame {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            max-width: 500px;
            width: 100%;
            margin: 20px auto;
            border: 1px solid #bfdbfe;
        }
        body.dark-mode .weather-announcement-frame {
            background-color: #1e293b;
            border-color: #334155;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .weather-announcement-frame .weather-card-inner,
        .weather-announcement-frame .message-announcement-card-inner {
            padding: 0;
            background-color: transparent;
            border: none;
            box-shadow: none;
            border-radius: 0;
        }

        .weather-announcement-frame .message-announcement-card {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        body.dark-mode .weather-announcement-frame .message-announcement-card {
            border-top-color: #334155;
        }

        /* --- START: DARK MODE STYLES --- */
        body.dark-mode {
            background-color: #0f172a; /* slate-900 */
            color: #e2e8f0; /* slate-200 */
        }
        /* General Text */
        body.dark-mode .text-slate-800 { color: #e2e8f0; }
        body.dark-mode .text-slate-700 { color: #cbd5e1; }
        body.dark-mode .text-slate-600 { color: #94a3b8; }
        body.dark-mode .text-slate-500 { color: #64748b; }

        /* Backgrounds and Borders */
        body.dark-mode .bg-white { background-color: #1e293b; } /* slate-800 */
        body.dark-mode .border-slate-200 { border-color: #334155; } /* slate-700 */
        body.dark-mode .border-slate-300 { border-color: #475569; } /* slate-600 */

        /* Search Bar */
        body.dark-mode #searchBarContainer {
            background-color: #1e293b; /* slate-800 */
            border-color: #475569; /* slate-600 */
        }
        body.dark-mode #categoryDisplay { color: #93c5fd; } /* blue-300 */
        body.dark-mode #searchBarContainer .w-px { background-color: #475569; }
        body.dark-mode #routeSearchInput { color: #e2e8f0; }
        body.dark-mode #routeSearchInput::placeholder { color: #94a3b8; }
        body.dark-mode #searchBarContainer svg { color: #94a3b8; }

        /* Loading & Messages */
        body.dark-mode .loading-spinner {
            border: 4px solid #334155; /* slate-700 */
            border-top: 4px solid #60a5fa; /* blue-400 */
        }
        body.dark-mode #noResultsMessage, body.dark-mode #noFavoritesMessage { color: #94a3b8; }

        /* Keyboard */
        body.dark-mode #filterKeyboardContainer {
            background-color: #1e293b; /* slate-800 */
            border-top-color: #334155; /* slate-700 */
        }
        body.dark-mode #filterKeyboard button {
             transition: background-color 0.2s ease;
        }
        body.dark-mode #filterKeyboard button[data-type="number"],
        body.dark-mode #filterKeyboard button[data-filter="幹線"],
        body.dark-mode #filterKeyboard button[data-filter="E"],
        body.dark-mode #filterKeyboard button[data-filter="其他"],
        body.dark-mode #filterKeyboard button[data-filter="reset"],
        body.dark-mode #filterKeyboard button[data-filter="backspace"],
        body.dark-mode #filterKeyboard .bus-taxi-button {
            background-color: #334155; /* slate-700 */
            color: #e2e8f0;
        }
        body.dark-mode #filterKeyboard button[data-filter="紅"],
        body.dark-mode #filterKeyboard button[data-filter="橘"],
        body.dark-mode #filterKeyboard button[data-filter="黃"],
        body.dark-mode #filterKeyboard button[data-filter="綠"] {
            color: #0f172a; /* Darker text for contrast on bright buttons */
        }

        /* Bus Tracker Page */
        body.dark-mode #backButton {
            background-color: #334155;
            color: #e2e8f0;
        }
        body.dark-mode #backButton:hover { background-color: #475569; }
        body.dark-mode .direction-toggle-group { border-color: #60a5fa; }
        body.dark-mode .direction-button { background-color: transparent; color: #60a5fa; }
        body.dark-mode .direction-button.bg-blue-500 { background-color: #60a5fa; color: #1e293b; }

        /* Station List */
        body.dark-mode .station-icon-container { background-color: #0f172a; }
        body.dark-mode .station-dot { background-color: #60a5fa; }
        body.dark-mode .station-content { background-color: #1e293b; }

        /* Unified Time Pills for Dark Mode */
        body.dark-mode .time-pill.bg-slate-200 { background-color: #334155; color: #cbd5e1; }
        body.dark-mode .time-pill.bg-red-200 { background-color: #991b1b; color: #fecaca; }
        body.dark-mode .time-pill.bg-green-200 { background-color: #166534; color: #dcfce7; }
        body.dark-mode .time-pill.bg-blue-200 { background-color: #1e40af; color: #dbeafe; }
        body.dark-mode .favorite-time-display .time-pill.bg-yellow-200 { background-color: #854d0e; color: #fef9c3; }

        /* Favorite Cards Dark Mode */
        body.dark-mode .favorite-card-item.dragging { background: #0f172a; border-color: #60a5fa; }
        body.dark-mode .drag-handle { color: #64748b; }
        body.dark-mode .favorite-card-content { background-color: #1e293b; }

        /* Main Nav */
        body.dark-mode #mainNav {
            background-color: #1e293b; /* slate-800 */
            border-top-color: #334155; /* slate-700 */
        }
        body.dark-mode #mainNav button { color: #94a3b8; }
        body.dark-mode #mainNav button:hover { color: #93c5fd; }
        body.dark-mode #mainNav button.active-nav { color: #93c5fd; }

        /* Update Countdown & Error Message */
        body.dark-mode #updateCountdown {
            background-color: #e8def8;
            color: #1c1b1f;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        body.dark-mode #updateCountdown:hover {
            background-color: #d0bcff;
            color: #1c1b1f;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
        }
        body.dark-mode #errorMessage {
            background-color: #7f1d1d;
            border-color: #f87171;
            color: #fecaca;
        }

        /* Settings Page Dark Mode */
        body.dark-mode .dark\:bg-slate-800 { background-color: #1e293b !important; }
        body.dark-mode .dark\:text-slate-200 { color: #e2e8f0; }
        body.dark-mode .dark\:text-slate-300 { color: #cbd5e1; }
        body.dark-mode .dark\:text-slate-400 { color: #94a3b8; }
        body.dark-mode .dark\:border-slate-700 { border-color: #334155; }
        body.dark-mode .dark\:hover\:bg-slate-700:hover { background-color: #334155; }
        body.dark-mode .dark\:bg-slate-700 { background-color: #334155; }
        body.dark-mode .dark\:border-slate-600 { border-color: #475569; }
        body.dark-mode .dark\:peer-focus\:ring-blue-800:focus { --tw-ring-color: rgba(30, 64, 175, 0.5); }
        /* Added styles for language select in dark mode */
        body.dark-mode #languageSelect {
            background-color: #334155; /* slate-700, adjusted for better contrast */
            color: #e2e8f0; /* slate-200 */
            border-color: #475569; /* slate-600 */
        }

        /* Home(Weather) Page Dark Mode */
        body.dark-mode #homePage .weather-card {
            background-color: #1e293b; /* slate-800 */
            border-color: #334155; /* slate-700 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        body.dark-mode #homePage .weather-card-inner h2 {
            color: #e2e8f0; /* slate-200 */
        }
        body.dark-mode #homePage .weather-card-inner p {
            color: #cbd5e1; /* slate-300 */
        }
        body.dark-mode #homePage .weather-detail-grid .detail-item {
            background-color: #0f172a; /* slate-900 */
            border-color: #334155; /* slate-700 */
        }
        body.dark-mode #homePage .weather-detail-grid .detail-label {
            color: #94a3b8; /* slate-400 */
        }
        body.dark-mode #homePage .weather-detail-grid .detail-value {
            color: #e2e8f0; /* slate-200 */
        }
        body.dark-mode #homePage #temperature {
            color: #93c5fd; /* blue-300 */
        }
        body.dark-mode #homePage #weather-description {
            color: #cbd5e1; /* slate-300 */
        }
        body.dark-mode #homePage #error-message {
            color: #f87171; /* red-400 */
        }

        /* Dark mode for new message announcement section */
        body.dark-mode .message-announcement-card {
            background-color: #1e293b; /* slate-800 */
            border-color: #334155; /* slate-700 */
        }
        body.dark-mode .message-announcement-card h2 {
            color: #e2e8f0; /* slate-200 */
        }
        body.dark-mode .message-announcement-card .text-slate-600 {
            color: #94a3b8; /* slate-400 */
        }
        body.dark-mode .message-announcement-card .announcement-item {
            background-color: #0f172a; /* slate-900 */
            border-color: #334155; /* slate-700 */
        }
        body.dark-mode .message-announcement-card .announcement-item h3 {
            color: #e2e8f0; /* slate-200 */
        }
        body.dark-mode .message-announcement-card .announcement-item p {
            color: #cbd5e1; /* slate-300 */
        }
        /* --- END: DARK MODE STYLES --- */
    </style>
</head>
<body class="antialiased">

    <div id="routeSelectionPage" class="page">
        <div class="container mx-auto p-4 md:p-6 max-w-4xl">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-800" data-i18n="routeSelectionTitle">高雄市公車路線查詢</h1>
                <p class="text-slate-500 mt-2" data-i18n="routeSelectionSubtitle">請使用下方鍵盤或直接輸入以查詢路線</p>
            </header>

            <div id="searchBarStickyWrapper" class="sticky top-0 z-10 bg-transparent py-2">
                <div id="searchBarContainer" class="flex items-center gap-2 bg-white border-2 border-slate-300 rounded-xl shadow-sm py-1 px-2 mx-auto max-w-sm md:max-w-4xl">
                    <div class="flex-shrink-0 pl-3 pr-2">
                        <span id="categoryDisplay" class="font-semibold text-blue-600" data-i18n="allRoutes">全部路線</span>
                    </div>

                    <div class="w-px bg-slate-300 self-stretch my-2"></div>

                    <div class="relative flex-grow">
                        <input type="text" id="routeSearchInput" placeholder="請由鍵盤輸入號碼" class="w-full py-2 px-3 text-lg bg-transparent border-none focus:outline-none focus:ring-0 text-left" readonly>
                        <svg class="w-6 h-6 text-slate-400 absolute top-1/2 right-3 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
            </div>

            <div id="initialLoading" class="text-center py-20">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-4 text-slate-600" data-i18n="loadingRoutes">正在載入所有路線...</p>
            </div>

            <div id="routeListContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-4 max-w-sm md:max-w-4xl mx-auto">
                </div>
             <p id="noResultsMessage" class="text-center py-10 text-slate-500 text-lg hidden" data-i18n="noMatchingRoutes">找不到相符的路線。</p>
        </div>

        <div id="filterKeyboardContainer" class="fixed bottom-[70px] left-0 right-0 bg-slate-100 py-0 px-4 z-[999] shadow-lg">
            <div class="container mx-auto max-w-4xl">
                <div id="filterKeyboard" class="grid grid-cols-5 gap-x-0.5 gap-y-1 md:gap-2 py-2">
                    <button data-filter="紅" data-type="category" class="p-3 text-black font-bold bg-red-500 rounded-lg shadow-md">紅</button>
                    <button data-filter="幹線" data-type="category" class="p-3 bg-white rounded-lg shadow-md" data-i18n="mainLine">幹線</button>
                    <button data-filter="1" data-type="number" class="p-3 bg-white rounded-lg shadow-md">1</button>
                    <button data-filter="2" data-type="number" class="p-3 bg-white rounded-lg shadow-md">2</button>
                    <button data-filter="3" data-type="number" class="p-3 bg-white rounded-lg shadow-md">3</button>

                    <button data-filter="橘" data-type="category" class="p-3 text-black font-bold bg-orange-500 rounded-lg shadow-md">橘</button>
                    <button data-filter="E" data-type="category" class="p-3 bg-white rounded-lg shadow-md" data-i18n="expressLine">快線</button>
                    <button data-filter="4" data-type="number" class="p-3 bg-white rounded-lg shadow-md">4</button>
                    <button data-filter="5" data-type="number" class="p-3 bg-white rounded-lg shadow-md">5</button>
                    <button data-filter="6" data-type="number" class="p-3 bg-white rounded-lg shadow-md">6</button>

                    <button data-filter="黃" data-type="category" class="p-3 text-black font-bold bg-yellow-400 rounded-lg shadow-md">黃</button>
                    <button data-filter="小黃" data-type="category" class="bg-white rounded-lg shadow-md bus-taxi-button"><span class="bus-text" data-i18n="bus">公車</span><span class="taxi-text" data-i18n="taxi">小黃</span></button>
                    <button data-filter="7" data-type="number" class="p-3 bg-white rounded-lg shadow-md">7</button>
                    <button data-filter="8" data-type="number" class="p-3 bg-white rounded-lg shadow-md">8</button>
                    <button data-filter="9" data-type="number" class="p-3 bg-white rounded-lg shadow-md">9</button>

                    <button data-filter="綠" data-type="category" class="p-3 text-black font-bold bg-green-500 rounded-lg shadow-md">綠</button>
                    <button data-filter="其他" data-type="category" class="p-3 bg-white rounded-lg shadow-md" data-i18n="otherRoutes">其他</button>
                    <button data-filter="reset" data-type="action" class="p-3 bg-white rounded-lg shadow-md" data-i18n="reset">重設</button>
                    <button data-filter="0" data-type="number" class="p-3 bg-white rounded-lg shadow-md">0</button>
                    <button data-filter="backspace" data-type="action" class="p-3 bg-white text-slate-800 rounded-lg shadow-md flex justify-center items-center">
                        <span class="material-icons-outlined">backspace</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="busTrackerPage" class="page">
        <div class="container mx-auto p-4 md:p-6 max-w-4xl h-screen flex flex-col">

            <div class="flex-shrink-0">
                <header class="flex items-center justify-between mb-4">
                    </header>

                <div class="flex items-center justify-center mb-2">
                    <button id="backButton" class="bg-slate-200 hover:bg-slate-300 text-slate-700 p-2 rounded-full transition-colors flex items-center justify-center mr-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <h1 id="routeTitle" class="text-xl md:text-2xl font-bold text-slate-800 text-center flex-grow"></h1>
                    <div class="w-9 h-9 mr-2"></div>
                </div>
                <p id="routeDescription" class="text-sm text-slate-500 text-center mb-6"></p>

                <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 text-sm" role="alert">
                    <strong class="font-bold" data-i18n="errorTitle">錯誤!</strong>
                    <span class="block sm:inline" id="errorMessageText"></span>
                </div>

                <div class="direction-toggle-group flex justify-center mb-4 rounded-lg border-2 border-blue-500 overflow-hidden text-sm">
                    <button id="goDirectionButton" class="direction-button flex-1 p-1 font-semibold transition-colors" data-direction="1" data-i18n="goDirection">去程</button>
                    <button id="backDirectionButton" class="direction-button flex-1 p-1 font-semibold transition-colors" data-direction="2" data-i18n="backDirection">返程</button>
                </div>
            </div>
            <div id="estimateTimesSection" class="flex-grow relative overflow-hidden" style="touch-action: pan-y;">
                <div id="trackerLoading" class="text-center py-20 hidden">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="mt-4 text-slate-600 text-sm" data-i18n="loadingBusData">正在載入路線動態...</p>
                </div>
                <div id="stationListGo" class="station-list-container hidden">
                    <div id="stationListGoContent" class="space-y-3"></div>
                </div>
                <div id="stationListBack" class="station-list-container hidden">
                    <div id="stationListBackContent" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="favoriteStationsPage" class="page">
        <div class="container mx-auto p-4 md:p-6 max-w-4xl">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-800" data-i18n="favoritesTitle">常用站牌</h1>
                <p class="text-slate-500 mt-2" data-i18n="favoritesSubtitle">點擊可查看路線詳情，長按或右鍵可移除，拖動以排序。</p>
            </header>
            <div id="favoriteListContainer" class="space-y-3">
            </div>
            <div id="noFavoritesMessage" class="text-center py-20 text-slate-500 hidden">
                <p data-i18n="noFavoritesYet">還沒有常用站牌喔！</p>
                <p class="mt-2 text-sm" data-i18n="addFavoritesHint">在路線動態頁面，長按或右鍵點擊站牌即可將其加入最愛。</p>
            </div>
        </div>
    </div>

    <div id="mrtPage" class="page">
        <div class="container mx-auto p-4 md:p-6 max-w-4xl h-screen flex flex-col">
            <div class="flex-grow relative -mx-4 -mb-4 md:-mx-6 md:-mb-6">
                <!-- Iframe src is set to about:blank initially for lazy loading -->
                <iframe src="about:blank" id="mrtIframe" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div>

    <div id="homePage" class="page">
        <div class="container mx-auto p-4 md:p-6 max-w-4xl">
            <header class="text-center mb-4">
                <h1 class="text-2xl md:text-3xl font-bold text-slate-800" data-i18n="appTitle">高雄公車 App</h1>
                <p class="text-slate-500 mt-1" data-i18n="appSubtitle">您的即時公車夥伴</p>
            </header>
            <div class="weather-announcement-frame">
                <div class="weather-card-inner">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2" data-i18n="weatherTitle">高雄天氣</h2>
                    <p class="text-lg text-gray-600 mb-6" id="current-date"></p>

                    <div id="weatherLoading" class="loading-spinner"></div>
                    <div id="weatherErrorMessage" class="text-red-500 text-center hidden" data-i18n="weatherLoadError">無法載入天氣資料，請稍後再試。</div>

                    <div id="weatherInfo" class="hidden">
                        <div class="flex items-center justify-center mb-4">
                            <span id="weather-icon" class="text-5xl mr-3"></span>
                            <p class="text-4xl font-extrabold text-blue-600" id="temperature"></p>
                            <span class="text-2xl text-blue-600 ml-1">°C</span>
                        </div>
                        <p class="text-xl text-gray-700 font-semibold mb-4" id="weather-description"></p>

                        <div class="weather-detail-grid">
                            <div class="detail-item">
                                <div class="detail-label" data-i18n="apparentTemperature">體感溫度</div>
                                <div class="detail-value" id="apparent-temperature"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label" data-i18n="relativeHumidity">相對濕度</div>
                                <div class="detail-value" id="relative-humidity"></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label" data-i18n="windSpeed">風速</div>
                                <div class="detail-value" id="wind-speed"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="message-announcement-card message-announcement-card-inner bg-blue-50 rounded-lg shadow-md p-4 md:p-6 border border-blue-200">
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800 mb-4" data-i18n="announcementTitle">訊息公告</h2>
                    <div id="announcementContent">
                        <div id="announcementLoading" class="text-center py-4">
                            <div class="loading-spinner mx-auto"></div>
                            <p class="mt-2 text-slate-600" data-i18n="loadingAnnouncements">正在載入訊息公告...</p>
                        </div>
                        <p id="noAnnouncementsMessage" class="text-center py-4 text-slate-500 hidden" data-i18n="noAnnouncements">目前沒有任何訊息通知喔</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="settingsPage" class="page">
        <div class="container mx-auto p-4 md:p-6 max-w-4xl">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-800" data-i18n="settingsTitle">設定</h1>
                <p class="text-slate-500 mt-2" data-i18n="settingsSubtitle">調整應用程式設定。</p>
            </header>

            <div class="space-y-6">
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="p-4 border-b border-slate-200">
                        <h2 class="text-lg font-semibold text-slate-700" data-i18n="appearance">外觀</h2>
                    </div>
                    <div class="p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="material-icons-outlined text-slate-500 mr-3">dark_mode</span>
                                <span class="text-slate-600" data-i18n="darkMode">深色模式</span>
                            </div>
                            <label for="darkModeToggle" class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="darkModeToggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-slate-600 peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="p-4 border-b border-slate-200">
                        <h2 class="text-lg font-semibold text-slate-700" data-i18n="languageSettings">語言設定</h2>
                    </div>
                    <div class="p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <span class="material-icons-outlined text-slate-500 mr-3">language</span>
                                <span class="text-slate-600" data-i18n="selectLanguage">選擇語言</span>
                            </div>
                            <select id="languageSelect" class="bg-slate-100 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 dark:bg-slate-700 dark:border-slate-600 dark:placeholder-slate-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                                <option value="zh">繁體中文</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="p-4 border-b border-slate-200">
                        <h2 class="text-lg font-semibold text-slate-700" data-i18n="about">關於</h2>
                    </div>
                    <div class="p-4">
                        <a href="https://github.com/potatosserver/kaohsiung_live_bus" target="_blank" rel="noopener noreferrer" class="flex items-center justify-between text-slate-600 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg p-2 transition-colors -m-2">
                            <div class="flex items-center">
                                <svg class="w-6 h-6 mr-3 fill-current" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.168 6.839 9.492.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.378.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" clip-rule="evenodd" /></svg>
                                <span data-i18n="githubSource">GitHub 原始碼</span>
                            </div>
                            <span class="material-icons-outlined text-slate-400">open_in_new</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <button id="updateCountdown" style="display:none;">
        <span class="material-icons-outlined">autorenew</span>
        <span id="updateCountdownText" data-i18n="updateCountdown">30秒後更新</span>
    </button>

    <button id="favoriteActionButton" class="hidden">
        <span class="material-icons-outlined" id="favoriteActionIcon"></span>
        <span id="favoriteActionText"></span>
    </button>

    <div id="toastContainer" class="fixed bottom-20 left-1/2 -translate-x-1/2 z-[2000] flex flex-col items-center space-y-2"></div>

    <div id="mainNav">
        <button id="navHome" data-page="home">
            <span class="material-icons-outlined">home</span>
            <span data-i18n="navHome">首頁</span>
        </button>
        <button id="navDynamic" data-page="dynamic">
            <span class="material-icons-outlined">directions_bus</span>
            <span data-i18n="navDynamic">動態</span>
        </button>
        <button id="navFavorites" data-page="favorites">
            <span class="material-icons-outlined">favorite</span>
            <span data-i18n="navFavorites">最愛</span>
         </button>
        <button id="navMrt" data-page="mrt">
            <span class="material-icons-outlined">tram</span>
            <span data-i18n="navMrt">捷運</span>
        </button>
        <button id="navSettings" data-page="settings">
            <span class="material-icons-outlined">settings</span>
            <span data-i18n="navSettings">設定</span>
        </button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- CONFIG & GLOBAL VARS ---
            const API_URL = 'https://ibus.tbkc.gov.tw/ibus/graphql';
            const HEADERS = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            };

            // --- DOM ELEMENTS ---
            const body = document.body;
            const routeSelectionPage = document.getElementById('routeSelectionPage');
            const busTrackerPage = document.getElementById('busTrackerPage');
            const favoriteStationsPage = document.getElementById('favoriteStationsPage');
            const mrtPage = document.getElementById('mrtPage');
            const homePage = document.getElementById('homePage');
            const settingsPage = document.getElementById('settingsPage');
            const mrtIframe = document.getElementById('mrtIframe');


            const routeSearchInput = document.getElementById('routeSearchInput');
            const categoryDisplay = document.getElementById('categoryDisplay');
            const routeListContainer = document.getElementById('routeListContainer');
            const initialLoading = document.getElementById('initialLoading');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const filterKeyboard = document.getElementById('filterKeyboard');
            const filterKeyboardContainer = document.getElementById('filterKeyboardContainer');

            const backButton = document.getElementById('backButton');
            const trackerLoading = document.getElementById('trackerLoading');
            const routeTitle = document.getElementById('routeTitle');
            const routeDescription = document.getElementById('routeDescription');
            const stationListGo = document.getElementById('stationListGo');
            const stationListBack = document.getElementById('stationListBack');
            const stationListGoContent = document.getElementById('stationListGoContent');
            const stationListBackContent = document.getElementById('stationListBackContent');
            const errorMessageDiv = document.getElementById('errorMessage');
            const errorMessageText = document.getElementById('errorMessageText');
            const goDirectionButton = document.getElementById('goDirectionButton');
            const backDirectionButton = document.getElementById('backDirectionButton');
            const updateCountdownButton = document.getElementById('updateCountdown');
            const mainNav = document.getElementById('mainNav');

            const favoriteListContainer = document.getElementById('favoriteListContainer');
            const noFavoritesMessage = document.getElementById('noFavoritesMessage');
            const favoriteActionButton = document.getElementById('favoriteActionButton');
            const favoriteActionIcon = document.getElementById('favoriteActionIcon');
            const favoriteActionText = document.getElementById('favoriteActionText');
            const toastContainer = document.getElementById('toastContainer');

            const darkModeToggle = document.getElementById('darkModeToggle');
            const languageSelect = document.getElementById('languageSelect');

            const weatherLoadingElement = document.getElementById('weatherLoading');
            const weatherErrorMessageElement = document.getElementById('weatherErrorMessage');
            const weatherInfoElement = document.getElementById('weatherInfo');
            const temperatureElement = document.getElementById('temperature');
            const weatherDescriptionElement = document.getElementById('weather-description');
            const weatherIconElement = document.getElementById('weather-icon');
            const apparentTemperatureElement = document.getElementById('apparent-temperature');
            const relativeHumidityElement = document.getElementById('relative-humidity');
            const windSpeedElement = document.getElementById('wind-speed');
            const currentDateElement = document.getElementById('current-date');

            const announcementContent = document.getElementById('announcementContent');
            const announcementLoading = document.getElementById('announcementLoading');
            const noAnnouncementsMessage = document.getElementById('noAnnouncementsMessage');


            // --- STATE ---
            let allRoutes = [];
            let currentRouteData = null;
            let currentDirection = 1; // 1 for Go, 2 for Back
            let currentRouteId = null;
            let currentRouteName = null;
            let countdownInterval = null;
            let currentLang = localStorage.getItem("lang") || "zh";
            let routeDataLang = null;

            let activePage = 'dynamic';
            let selectedCategoryPrefix = '';

            let favoriteStations = [];
            let longPressTimer;
            let currentStationContext = null;
            let favoriteButtonHideTimeout;
            let draggedItem = null;

            let isAnimatingDirection = false;
            let lastPage = null;

            let weatherDataLoaded = false;
            let announcementsDataLoaded = false;
            let mrtIframeLoaded = false;


            // Translations object
            const translations = {
                zh: {
                    appTitle: '高雄公車 App',
                    appSubtitle: '您的即時公車夥伴',
                    routeSelectionTitle: '高雄市公車路線查詢',
                    routeSelectionSubtitle: '請使用下方鍵盤或直接輸入以查詢路線',
                    allRoutes: '全部路線',
                    routeSearchPlaceholder: '請由鍵盤輸入號碼',
                    loadingRoutes: '正在載入所有路線...',
                    noMatchingRoutes: '找不到相符的路線。',
                    mainLine: '幹線',
                    expressLine: '快線',
                    bus: '公車',
                    taxi: '小黃',
                    otherRoutes: '其他',
                    reset: '重設',
                    errorTitle: '錯誤!',
                    goDirection: '去程',
                    backDirection: '返程',
                    loadingBusData: '正在載入路線動態...',
                    noBusDataForDirection: '此方向目前沒有班次資訊。',
                    lastBusDeparted: '末班駛離',
                    approaching: '進站中',
                    arrivingSoon: '即將到站',
                    minutes: '分',
                    unknownStation: '未知站點',
                    removeFavorite: '移除最愛',
                    addFavorite: '加入最愛',
                    favoritesTitle: '常用站牌',
                    favoritesSubtitle: '點擊可查看路線詳情，長按或右鍵可移除，拖動以排序。',
                    noFavoritesYet: '還沒有常用站牌喔！',
                    addFavoritesHint: '在路線動態頁面，長按或右鍵點擊站牌即可將其加入最愛。',
                    settingsTitle: '設定',
                    settingsSubtitle: '調整應用程式設定。',
                    appearance: '外觀',
                    darkMode: '深色模式',
                    languageSettings: '語言設定',
                    selectLanguage: '選擇語言',
                    githubSource: 'GitHub 原始碼',
                    updateCountdown: '秒後更新',
                    navHome: '首頁',
                    navDynamic: '動態',
                    navFavorites: '最愛',
                    navMrt: '捷運',
                    navSettings: '設定',
                    noData: '無資料',
                    routeInfoNotFound: '找不到該路線的資訊，請確認路線代號是否正確。',
                    mrtTitle: '高雄捷運路網圖',
                    weatherTitle: '高雄天氣',
                    weatherLoadError: '無法載入天氣資料，請稍後再試。',
                    apparentTemperature: '體感溫度',
                    relativeHumidity: '相對濕度',
                    windSpeed: '風速',
                    weatherClear: '晴朗',
                    weatherMostlyClear: '主要晴朗',
                    weatherPartlyCloudy: '局部多雲',
                    weatherOvercast: '多雲',
                    weatherFog: '霧',
                    weatherDepositingFog: '結霜霧',
                    weatherDrizzleLight: '毛毛雨：小雨',
                    weatherDrizzleModerate: '毛毛雨：中雨',
                    weatherDrizzleDense: '毛毛雨：大雨',
                    weatherFreezingDrizzleLight: '凍毛毛雨：小雨',
                    weatherFreezingDrizzleDense: '凍毛毛雨：大雨',
                    weatherRainLight: '小雨',
                    weatherRainModerate: '中雨',
                    weatherRainHeavy: '大雨',
                    weatherFreezingRainLight: '凍雨：小雨',
                    weatherFreezingRainHeavy: '凍雨：大雨',
                    weatherSnowLight: '小雪',
                    weatherSnowModerate: '中雪',
                    weatherSnowHeavy: '大雪',
                    weatherSnowGrains: '雪粒',
                    weatherRainShowersLight: '陣雨：小雨',
                    weatherRainShowersModerate: '陣雨：中雨',
                    weatherRainShowersHeavy: '陣雨：大雨',
                    weatherSnowShowersLight: '陣雪：小雪',
                    weatherSnowShowersHeavy: '陣雪：大雪',
                    weatherThunderstorm: '雷暴',
                    weatherThunderstormHailLight: '雷暴伴隨小冰雹',
                    weatherThunderstormHailHeavy: '雷暴伴隨大冰雹',
                    weatherUnknown: '未知天氣',
                    announcementTitle: '訊息公告',
                    loadingAnnouncements: '正在載入訊息公告...',
                    noAnnouncements: '目前沒有任何訊息通知喔'
                },
                en: {
                    appTitle: 'Kaohsiung Bus App',
                    appSubtitle: 'Your real-time bus partner',
                    routeSelectionTitle: 'Kaohsiung Bus Route Inquiry',
                    routeSelectionSubtitle: 'Use keyboard to find routes',
                    allRoutes: 'All Routes',
                    routeSearchPlaceholder: 'Enter route no.',
                    loadingRoutes: 'Loading all routes...',
                    noMatchingRoutes: 'No matching routes found.',
                    mainLine: 'Main Line',
                    expressLine: 'Express',
                    bus: 'Bus',
                    taxi: 'Taxi',
                    otherRoutes: 'Other',
                    reset: 'Reset',
                    errorTitle: 'Error!',
                    goDirection: 'To Destination',
                    backDirection: 'To Origin',
                    loadingBusData: 'Loading bus data...',
                    noBusDataForDirection: 'No bus information available for this direction.',
                    lastBusDeparted: 'Last bus departed',
                    approaching: 'Approaching',
                    arrivingSoon: 'Arriving Soon',
                    minutes: 'min',
                    unknownStation: 'Unknown Station',
                    removeFavorite: 'Remove Favorite',
                    addFavorite: 'Add Favorite',
                    favoritesTitle: 'Favorite Stops',
                    favoritesSubtitle: 'Tap to view details, long-press or right-click to remove, drag to reorder.',
                    noFavoritesYet: 'No favorite stops yet!',
                    addFavoritesHint: 'On the dynamic route page, long-press or right-click a stop to add it to favorites.',
                    settingsTitle: 'Settings',
                    settingsSubtitle: 'Adjust application settings.',
                    appearance: 'Appearance',
                    darkMode: 'Dark Mode',
                    languageSettings: 'Language Settings',
                    selectLanguage: 'Select Language',
                    githubSource: 'GitHub Source Code',
                    updateCountdown: 's to update',
                    navHome: 'Home',
                    navDynamic: 'Dynamic',
                    navFavorites: 'Favorites',
                    navMrt: 'MRT',
                    navSettings: 'Settings',
                    noData: 'No Data',
                    routeInfoNotFound: 'Route information not found. Please check if the route number is correct.',
                    mrtTitle: 'Kaohsiung MRT Map',
                    weatherTitle: 'Kaohsiung Weather',
                    weatherLoadError: 'Failed to load weather data, please try again later.',
                    apparentTemperature: 'Apparent Temp',
                    relativeHumidity: 'Humidity',
                    windSpeed: 'Wind Speed',
                    weatherClear: 'Clear',
                    weatherMostlyClear: 'Mostly Clear',
                    weatherPartlyCloudy: 'Partly Cloudy',
                    weatherOvercast: 'Overcast',
                    weatherFog: 'Fog',
                    weatherDepositingFog: 'Depositing Fog',
                    weatherDrizzleLight: 'Light Drizzle',
                    weatherDrizzleModerate: 'Moderate Drizzle',
                    weatherDrizzleDense: 'Dense Drizzle',
                    weatherFreezingDrizzleLight: 'Light Freezing Drizzle',
                    weatherFreezingDrizzleDense: 'Dense Freezing Drizzle',
                    weatherRainLight: 'Light Rain',
                    weatherRainModerate: 'Moderate Rain',
                    weatherRainHeavy: 'Heavy Rain',
                    weatherFreezingRainLight: 'Light Freezing Rain',
                    weatherFreezingRainHeavy: 'Heavy Freezing Rain',
                    weatherSnowLight: 'Light Snow',
                    weatherSnowModerate: 'Moderate Snow',
                    weatherSnowHeavy: 'Heavy Snow',
                    weatherSnowGrains: 'Snow Grains',
                    weatherRainShowersLight: 'Light Rain Showers',
                    weatherRainShowersModerate: 'Moderate Rain Showers',
                    weatherRainShowersHeavy: 'Heavy Rain Showers',
                    weatherSnowShowersLight: 'Light Snow Showers',
                    weatherSnowShowersHeavy: 'Heavy Snow Showers',
                    weatherThunderstorm: 'Thunderstorm',
                    weatherThunderstormHailLight: 'Thunderstorm with Light Hail',
                    weatherThunderstormHailHeavy: 'Thunderstorm with Heavy Hail',
                    weatherUnknown: 'Unknown Weather',
                    announcementTitle: 'Message Announcements',
                    loadingAnnouncements: 'Loading announcements...',
                    noAnnouncements: 'Currently no message notifications.'
                }
            };

            const categoryFilters = [
                { prefix: '公車小黃', filterValue: '小黃', i18nKey: 'busTaxi' },
                { prefix: '紅', filterValue: '紅', i18nKey: 'redLine' },
                { prefix: '橘', filterValue: '橘', i18nKey: 'orangeLine' },
                { prefix: '黃', filterValue: '黃', i18nKey: 'yellowLine' },
                { prefix: '綠', filterValue: '綠', i18nKey: 'greenLine' },
                { prefix: '其他', filterValue: '其他', i18nKey: 'otherRoutes' },
                { prefix: '幹線', filterValue: '幹線', i18nKey: 'mainLine' },
                { prefix: '快線', filterValue: 'E', i18nKey: 'expressLine' }
            ];

            const categoryDisplayMap = {
                '紅': 'redLineShuttle',
                '橘': 'orangeLineShuttle',
                '黃': 'yellowLineShuttle',
                '綠': 'greenLineShuttle',
                '幹線': 'mainLineBus',
                'E': 'expressLineBus',
                '小黃': 'busTaxiBus',
                '其他': 'otherRoutes'
            };

            translations.zh.redLineShuttle = '紅線接駁';
            translations.zh.orangeLineShuttle = '橘線接駁';
            translations.zh.yellowLineShuttle = '黃線接駁';
            translations.zh.greenLineShuttle = '綠線接駁';
            translations.zh.mainLineBus = '幹線公車';
            translations.zh.expressLineBus = '快線公車';
            translations.zh.busTaxiBus = '公車小黃';

            translations.en.redLineShuttle = 'Red Line Shuttle';
            translations.en.orangeLineShuttle = 'Orange Line Shuttle';
            translations.en.yellowLineShuttle = 'Yellow Line Shuttle';
            translations.en.greenLineShuttle = 'Green Line Shuttle';
            translations.en.mainLineBus = 'Main Line Bus';
            translations.en.expressLineBus = 'Express Line Bus';
            translations.en.busTaxiBus = 'Bus Taxi';

            translations.zh.busTaxi = '公車小黃';
            translations.zh.redLine = '紅';
            translations.zh.orangeLine = '橘';
            translations.zh.yellowLine = '黃';
            translations.zh.greenLine = '綠';

            translations.en.busTaxi = 'Bus Taxi';
            translations.en.redLine = 'Red';
            translations.en.orangeLine = 'Orange';
            translations.en.yellowLine = 'Yellow';
            translations.en.greenLine = 'Green';

            const GQL = {
                QUERY_SIDE_ROUTES: `query QUERY_SIDE_ROUTES($lang: String!) {
                    routes(lang: $lang) {
                        edges {
                            node {
                                id, opType, id, seq, name, description
                            }
                        }
                    }
                }`,
                QUERY_ROUTE_DETAILS: `query QUERY_ESTIMATE_TIMES($routeId: Int!, $lang: String!) {
                    route(xno: $routeId, lang: $lang) {
                        opType, departure, destination
                        estimateTimes { edges { node { id, goBack, comeTime, etas { busId, etaTime } } } }
                        stations { edges { ivrNo, node { id, name } } }
                    }
                }`,
                QUERY_CLOGS: `query QUERY_CLOGS($routeId: Int!) {
                    clogMessages(xno: $routeId) {
                        edges {
                            node {
                                id, title, description
                            }
                        }
                    }
                    abnormalMessages(xno: $routeId) {
                        edges {
                            node {
                                id, type, title, description
                            }
                        }
                    }
                }`
            };

            // --- DARK MODE LOGIC ---
            function updateMrtIframeSrc() {
                const isDarkMode = body.classList.contains('dark-mode');
                const darkSrc = 'https://krtc.pages.dev/?mode=dark';
                const lightSrc = 'https://krtc.pages.dev/';
                const newSrc = isDarkMode ? darkSrc : lightSrc;

                // Only update src if it has been loaded before to avoid premature loading
                if (mrtIframeLoaded) {
                    mrtIframe.src = newSrc;
                }
            }

            function applyInitialTheme() {
                const isDarkMode = localStorage.getItem('darkMode') === 'true';
                darkModeToggle.checked = isDarkMode;
                if (isDarkMode) {
                    body.classList.add('dark-mode');
                } else {
                    body.classList.remove('dark-mode');
                }
                updateMrtIframeSrc();
            }

            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    body.classList.add('dark-mode');
                    localStorage.setItem('darkMode', 'true');
                } else {
                    body.classList.remove('dark-mode');
                    localStorage.setItem('darkMode', 'false');
                }
                updateMrtIframeSrc();
            });

            // --- LANGUAGE LOGIC ---
            async function setLanguage(lang) {
                if (lang === currentLang) return;

                currentLang = lang;
                localStorage.setItem('lang', lang);

                // 1. Update static UI text
                applyTranslations();

                // 2. Mark ALL language-dependent data as stale to force re-fetch/re-render
                routeDataLang = null;
                weatherDataLoaded = false;
                announcementsDataLoaded = false;

                // 3. Refresh data for the current active page
                switch (activePage) {
                    case 'routeSelectionPage':
                        await initRouteSelection();
                        break;
                    case 'busTrackerPage':
                        if (currentRouteId) {
                            await loadBusData(currentRouteId, true); // Use true to show loading spinner
                        }
                        break;
                    case 'favoriteStationsPage':
                        await displayFavoriteStations();
                        break;
                    case 'homePage':
                        await fetchWeather();
                        await fetchAnnouncements();
                        break;
                }
            }

            function applyTranslations() {
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.dataset.i18n;
                    if (translations[currentLang] && translations[currentLang][key]) {
                        element.textContent = translations[currentLang][key];
                    }
                });

                routeSearchInput.placeholder = translations[currentLang].routeSearchPlaceholder;

                if (selectedCategoryPrefix) {
                    const categoryFilter = categoryFilters.find(cat => cat.prefix === selectedCategoryPrefix);
                    if (categoryFilter && translations[currentLang][categoryDisplayMap[categoryFilter.filterValue]]) {
                        categoryDisplay.textContent = translations[currentLang][categoryDisplayMap[categoryFilter.filterValue]];
                    } else {
                        categoryDisplay.textContent = translations[currentLang].allRoutes;
                    }
                } else {
                    categoryDisplay.textContent = translations[currentLang].allRoutes;
                }

                filterKeyboard.querySelectorAll('button[data-type="category"]').forEach(button => {
                    const filterValue = button.dataset.filter;
                    const categoryFilter = categoryFilters.find(cat => cat.filterValue === filterValue);
                    if (categoryFilter && translations[currentLang][categoryFilter.i18nKey]) {
                        if (filterValue === '小黃') {
                            button.querySelector('.bus-text').textContent = translations[currentLang].bus;
                            button.querySelector('.taxi-text').textContent = translations[currentLang].taxi;
                        } else {
                            button.textContent = translations[currentLang][categoryFilter.i18nKey];
                        }
                    }
                });

                if (countdownTimer) {
                    countdownTimer.updateDisplay();
                }
            }

            languageSelect.addEventListener('change', async (e) => {
                await setLanguage(e.target.value);
            });

            languageSelect.value = currentLang;

            // --- UTILITY FUNCTIONS ---
            async function fetchAPI(query, variables) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: HEADERS,
                        body: JSON.stringify({ query, variables })
                    });
                    if (!response.ok) throw new Error(`${translations[currentLang].errorTitle} HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error("API Fetch Error:", error);
                    throw error;
                }
            }

            function loadFavorites() {
                try {
                    const favorites = localStorage.getItem('favoriteStations');
                    favoriteStations = favorites ? JSON.parse(favorites) : [];
                } catch (e) {
                    console.error("Error loading favorites from localStorage:", e);
                    favoriteStations = [];
                }
            }

            function saveFavorites() {
                try {
                    localStorage.setItem('favoriteStations', JSON.stringify(favoriteStations));
                } catch (e) {
                    console.error("Error saving favorites to localStorage:", e);
                }
            }

            function isFavorite(routeId, stationId, direction) {
                return favoriteStations.some(fav => fav.routeId === Number(routeId) && fav.stationId === String(stationId) && fav.direction === Number(direction));
            }

            function toggleFavorite(stationData) {
                const routeId = Number(stationData.routeId);
                const stationId = String(stationData.stationId);
                const direction = Number(stationData.direction);
                const { routeName, stationName, destination } = stationData;

                const index = favoriteStations.findIndex(fav => fav.routeId === routeId && fav.stationId === stationId && fav.direction === direction);

                if (index > -1) {
                    favoriteStations.splice(index, 1);
                } else {
                    favoriteStations.push({ routeId, routeName, stationId, stationName, direction, destination });
                }
                
                announcementsDataLoaded = false;
                saveFavorites();

                if (busTrackerPage.classList.contains('active') && currentRouteId) {
                    loadBusData(currentRouteId, false);
                }
            }
            
            function positionAndShowActionButton(clientX, clientY) {
                favoriteActionButton.classList.remove('hidden');
                favoriteActionButton.classList.add('show');
                const buttonWidth = favoriteActionButton.offsetWidth;
                const buttonHeight = favoriteActionButton.offsetHeight;
                let left = clientX; let top = clientY;
                if (left + buttonWidth > window.innerWidth - 10) left = window.innerWidth - buttonWidth - 10;
                if (top + buttonHeight > window.innerHeight - 10) top = window.innerHeight - buttonHeight - 10;
                if (left < 10) left = 10; if (top < 10) top = 10;
                favoriteActionButton.style.left = `${left}px`;
                favoriteActionButton.style.top = `${top}px`;
                favoriteButtonHideTimeout = setTimeout(() => { hideFavoriteButton(); }, 4000);
            }
            
            // MODIFIED: Unified "Add/Remove" button logic
            function showFavoriteButton(stationData, clientX, clientY) {
                clearTimeout(favoriteButtonHideTimeout);
                currentStationContext = { ...stationData, action: 'toggle' };
                const isCurrentlyFavorite = isFavorite(stationData.routeId, stationData.stationId, stationData.direction);
                favoriteActionIcon.textContent = 'favorite_border'; 
                favoriteActionText.textContent = isCurrentlyFavorite ? translations[currentLang].removeFavorite : translations[currentLang].addFavorite;
                positionAndShowActionButton(clientX, clientY);
            }
            
            // MODIFIED: Unified "Remove" button logic for Favorites page
            function showRemoveFavoriteButton(stationData, clientX, clientY) {
                clearTimeout(favoriteButtonHideTimeout);
                currentStationContext = { ...stationData, action: 'remove' };
                favoriteActionIcon.textContent = 'favorite_border';
                favoriteActionText.textContent = translations[currentLang].removeFavorite;
                positionAndShowActionButton(clientX, clientY);
            }

            function hideFavoriteButton() {
                clearTimeout(favoriteButtonHideTimeout);
                favoriteActionButton.classList.remove('show');
                favoriteActionButton.addEventListener('transitionend', () => {
                    favoriteActionButton.classList.add('hidden');
                }, { once: true });
            }

            favoriteActionButton.addEventListener('click', () => {
                if (currentStationContext) {
                    toggleFavorite(currentStationContext);
                    hideFavoriteButton();

                    if (currentStationContext.action === 'remove' && activePage === 'favoriteStationsPage') {
                        displayFavoriteStations();
                    }
                }
            });

            // --- PAGE MANAGEMENT & HISTORY LOGIC ---
            function showPage(pageId, pushState = true) {
                if (activePage === pageId) return;

                lastPage = activePage;
                activePage = pageId;

                const pages = document.querySelectorAll('.page');
                pages.forEach(page => page.classList.remove('active'));
                const newPage = document.getElementById(pageId);
                if (newPage) {
                    newPage.classList.add('active');
                } else {
                    console.error(`Page with ID "${pageId}" not found.`);
                    document.getElementById('homePage').classList.add('active');
                    activePage = 'homePage';
                }

                if (pushState) {
                    const state = { page: pageId };
                    const url = `?page=${pageId.replace('Page', '')}`;
                    history.pushState(state, '', url);
                }

                if (pageId === 'routeSelectionPage') {
                    filterKeyboardContainer.style.display = 'block';
                    updateCountdownButton.style.display = 'none';
                    adjustContentPadding();
                } else if (pageId === 'busTrackerPage') {
                    filterKeyboardContainer.style.display = 'none';
                    if (navigator.onLine) {
                        updateCountdownButton.style.display = 'flex';
                    } else {
                        updateCountdownButton.style.display = 'none';
                    }
                } else {
                    filterKeyboardContainer.style.display = 'none';
                    updateCountdownButton.style.display = 'none';
                    const container = document.querySelector(`#${pageId} .container`);
                    if(container) {
                        container.style.paddingBottom = '90px';
                    }
                }

                document.querySelectorAll('#mainNav button').forEach(button => {
                    button.classList.remove('active-nav');
                });

                let navButtonId = pageId.replace('Page', '');
                if (pageId === 'routeSelectionPage' || pageId === 'busTrackerPage') {
                    navButtonId = 'dynamic';
                }
                const navButton = document.querySelector(`#mainNav button[data-page="${navButtonId}"]`);
                if (navButton) {
                    navButton.classList.add('active-nav');
                }

                // Page-specific lazy-loading and data fetching
                if (pageId === 'favoriteStationsPage') {
                    displayFavoriteStations();
                } else if (pageId === 'homePage') {
                    if (!weatherDataLoaded) {
                        fetchWeather();
                        weatherDataLoaded = true;
                    }
                    if (!announcementsDataLoaded) {
                        fetchAnnouncements();
                    }
                } else if (pageId === 'mrtPage' && !mrtIframeLoaded) {
                    // Lazy load MRT iframe content
                    mrtIframeLoaded = true;
                    updateMrtIframeSrc();
                }
            }


            window.addEventListener('popstate', (event) => {
                const fromPage = activePage;
                const spokePages = ['routeSelectionPage', 'favoriteStationsPage', 'mrtPage', 'settingsPage'];

                if (spokePages.includes(fromPage)) {
                    showPage('homePage', true);
                    return;
                }

                if (event.state && event.state.page) {
                    const pageId = event.state.page;

                    if (pageId === 'busTrackerPage') {
                        const routeId = event.state.routeId;
                        if (routeId) {
                            const route = allRoutes.find(r => r.id.toString() === routeId.toString());
                            if (route) {
                                navigateToTracker(route.id, route.name, route.description, false);
                            } else {
                                showPage('routeSelectionPage', false);
                            }
                        } else {
                             showPage('routeSelectionPage', false);
                        }
                    } else {
                        showPage(pageId, false);
                    }
                } else {
                    showPage('homePage', false);
                }
            });


            // --- PAGE 1: ROUTE SELECTION ---
            function resetSearch() {
                selectedCategoryPrefix = '';
                routeSearchInput.value = '';
                categoryDisplay.textContent = translations[currentLang].allRoutes;
                if (allRoutes.length > 0) {
                   applySearch('');
                }
            }

            async function initRouteSelection() {
                try {
                    initialLoading.style.display = 'block';
                    routeListContainer.innerHTML = '';

                    const data = await fetchAPI(GQL.QUERY_SIDE_ROUTES, { lang: currentLang });
                    allRoutes = data.data.routes.edges
                        .map(edge => edge.node)
                        .filter(route => route.id !== 0)
                        .sort((a, b) => a.seq - b.seq);

                    routeDataLang = currentLang;

                    initialLoading.style.display = 'none';
                    const fullSearchTerm = selectedCategoryPrefix + routeSearchInput.value;
                    if (fullSearchTerm.trim()) {
                        applySearch(fullSearchTerm);
                    } else {
                        displayInitialPrompt();
                    }
                } catch (error) {
                    routeDataLang = null;
                    initialLoading.innerHTML = `<p class="text-red-500">${translations[currentLang].loadingRoutesError || '無法載入路線列表，請重新整理頁面。'}</p>`;
                }
            }

            function displayInitialPrompt() {
                routeListContainer.innerHTML = `
                    <div id="initialPrompt" class="text-center col-span-full py-10 text-slate-500">
                        <p class="text-lg">${translations[currentLang].routeSelectionSubtitle}</p>
                    </div>`;
                noResultsMessage.style.display = 'none';
            }

            function displayRoutes(routes) {
                routeListContainer.innerHTML = '';
                if (routes.length === 0) {
                    noResultsMessage.style.display = 'block';
                } else {
                    noResultsMessage.style.display = 'none';
                }

                routes.forEach(route => {
                    const card = document.createElement('div');
                    card.className = 'route-card p-4 bg-white rounded-lg shadow-md cursor-pointer border-l-4 border-transparent hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors';
                    card.dataset.routeId = route.id;
                    card.dataset.routeName = route.name;
                    card.dataset.routeDesc = route.description;

                    card.innerHTML = `
                        <h3 class="font-bold text-lg text-slate-800 dark:text-slate-200">${route.name}</h3>
                        <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">${route.description || '&nbsp;'}</p>
                    `;

                    card.addEventListener('click', () => {
                        navigateToTracker(card.dataset.routeId, card.dataset.routeName, card.dataset.routeDesc);
                    });
                    routeListContainer.appendChild(card);
                });
            }

            function applySearch(searchTerm) {
                const lowerCaseTerm = searchTerm.toLowerCase().trim();

                if (!lowerCaseTerm) {
                    displayInitialPrompt();
                    return;
                }

                let filteredRoutes = [...allRoutes];
                let categoryMatched = false;
                let remainingSearchTerm = lowerCaseTerm;

                for (const category of categoryFilters) {
                    const lowerCasePrefix = translations[currentLang][category.i18nKey] ? translations[currentLang][category.i18nKey].toLowerCase() : category.prefix.toLowerCase();

                    if (lowerCaseTerm.startsWith(lowerCasePrefix)) {
                        const filterVal = category.filterValue;

                        if (filterVal === '其他') {
                            filteredRoutes = allRoutes.filter(route =>
                                route.name.toLowerCase().includes('joy') ||
                                route.name.toLowerCase().includes('dashu blessing bus') ||
                                route.name.toLowerCase().includes('大樹祈福')
                            );
                        } else if (filterVal === 'E') {
                            filteredRoutes = allRoutes.filter(route => route.name.toLowerCase().startsWith('e'));
                        } else if (filterVal === '小黃') {
                            filteredRoutes = allRoutes.filter(route => route.opType === 9);
                        } else if (filterVal === '幹線') {
                            const keyword = currentLang === 'en' ? 'main line' : '幹線';
                            filteredRoutes = allRoutes.filter(route => route.name.toLowerCase().includes(keyword));
                        } else if (['紅', '橘', '黃', '綠'].includes(filterVal)) {
                            const keyword = translations[currentLang][category.i18nKey].toLowerCase();
                             if (currentLang === 'zh' && filterVal === '黃') {
                                filteredRoutes = allRoutes.filter(route => route.name.includes(keyword) && route.opType !== 9);
                            } else {
                                filteredRoutes = allRoutes.filter(route => route.name.toLowerCase().includes(keyword));
                            }
                        }

                        remainingSearchTerm = lowerCasePrefix.length > 0 ? lowerCaseTerm.substring(lowerCasePrefix.length).trim() : lowerCaseTerm;
                        categoryMatched = true;
                        break;
                    }
                }

                if (remainingSearchTerm) {
                    const finalFilterTarget = categoryMatched ? filteredRoutes : allRoutes;
                    filteredRoutes = finalFilterTarget.filter(route =>
                        route.name.toLowerCase().includes(remainingSearchTerm) ||
                        (route.description && route.description.toLowerCase().includes(remainingSearchTerm))
                    );
                }

                displayRoutes(filteredRoutes);
            }

            filterKeyboard.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const value = button.dataset.filter;
                const type = button.dataset.type;

                button.classList.add('active-keyboard-button');
                setTimeout(() => {
                    button.classList.remove('active-keyboard-button');
                }, 150);

                if (type === 'category') {
                    let searchPrefix;
                    const categoryObj = categoryFilters.find(cat => cat.filterValue === value);
                    if(categoryObj && translations[currentLang][categoryObj.i18nKey]){
                         searchPrefix = translations[currentLang][categoryObj.i18nKey];
                    } else {
                         searchPrefix = button.textContent;
                    }

                    selectedCategoryPrefix = searchPrefix;
                    categoryDisplay.textContent = translations[currentLang][categoryDisplayMap[value]] || translations[currentLang].allRoutes;
                    routeSearchInput.value = '';

                } else if (type === 'number') {
                    routeSearchInput.value += value;

                } else if (type === 'action') {
                    if (value === 'reset') {
                        resetSearch();
                    } else if (value === 'backspace') {
                        routeSearchInput.value = routeSearchInput.value.slice(0, -1);
                    }
                }

                const fullSearchTerm = selectedCategoryPrefix + routeSearchInput.value;
                applySearch(fullSearchTerm);
            });

            // --- PAGE 2: BUS TRACKER ---
            function updateDirectionButtons() {
                if (!currentRouteData) return;

                goDirectionButton.textContent = `${translations[currentLang].goDirection} ${currentRouteData.destination}`;
                backDirectionButton.textContent = `${translations[currentLang].backDirection} ${currentRouteData.departure}`;

                if (currentDirection === 1) {
                    goDirectionButton.classList.add('bg-blue-500', 'text-white');
                    goDirectionButton.classList.remove('bg-white', 'text-blue-500');
                    backDirectionButton.classList.add('bg-white', 'text-blue-500');
                    backDirectionButton.classList.remove('bg-blue-500', 'text-white');
                } else {
                    backDirectionButton.classList.add('bg-blue-500', 'text-white');
                    backDirectionButton.classList.remove('bg-white', 'text-blue-500');
                    goDirectionButton.classList.add('bg-white', 'text-blue-500');
                    goDirectionButton.classList.remove('bg-blue-500', 'text-white');
                }
            }

            function handleDirectionToggle(newDirection) {
                if (newDirection === currentDirection || !currentRouteData || isAnimatingDirection) {
                    return;
                }

                isAnimatingDirection = true;

                const outgoingList = (currentDirection === 1) ? stationListGo : stationListBack;
                const incomingList = (newDirection === 1) ? stationListGo : stationListBack;

                const slideOutClass = newDirection > currentDirection ? 'slide-out-left' : 'slide-out-right';
                const slideInClass = newDirection > currentDirection ? 'slide-in-from-right' : 'slide-in-from-left';

                incomingList.classList.remove('hidden');
                outgoingList.className = 'station-list-container';
                incomingList.className = 'station-list-container';

                outgoingList.classList.add(slideOutClass);
                incomingList.classList.add(slideInClass);

                currentDirection = newDirection;
                updateDirectionButtons();

                setTimeout(() => {
                    outgoingList.classList.add('hidden');
                    outgoingList.classList.remove(slideOutClass);
                    incomingList.classList.remove(slideInClass);
                    isAnimatingDirection = false;
                }, 300);
            }

            function createStationCard(estimate, stationName, displayedBusIds) {
                let timeDisplay = translations[currentLang].lastBusDeparted;
                let busIdDisplayHtml = '';
                let pillBgColorClass = 'bg-slate-200';

                if (estimate.etas && estimate.etas.length > 0) {
                    const closestEta = estimate.etas.reduce((minEta, currentEta) => {
                        const minTime = minEta.etaTime !== null ? minEta.etaTime : Infinity;
                        const currentTime = currentEta.etaTime !== null ? currentEta.etaTime : Infinity;
                        return currentTime < minTime ? currentEta : minEta;
                    }, { etaTime: Infinity });

                    if (closestEta.etaTime !== Infinity && closestEta.etaTime !== null) {
                        if (closestEta.etaTime <= 1) {
                            timeDisplay = translations[currentLang].approaching;
                            pillBgColorClass = 'bg-red-200';
                        } else if (closestEta.etaTime <= 3) {
                            timeDisplay = translations[currentLang].arrivingSoon;
                            pillBgColorClass = 'bg-green-200';
                        } else {
                            timeDisplay = `${closestEta.etaTime}${translations[currentLang].minutes}`;
                            pillBgColorClass = 'bg-blue-200';
                        }

                        if (closestEta.busId && !displayedBusIds.has(closestEta.busId)) {
                            busIdDisplayHtml = `<div class="bus-id-display">
                                                    <span class="material-icons-outlined text-sm">directions_bus</span>
                                                    <span>${closestEta.busId}</span>
                                                </div>`;
                            displayedBusIds.add(closestEta.busId);
                        }
                    }
                } else if (estimate.comeTime) {
                    timeDisplay = estimate.comeTime;
                    pillBgColorClass = 'bg-slate-200';
                }

                const stationCard = document.createElement('div');
                stationCard.className = 'station-item';
                stationCard.dataset.stationId = estimate.id;
                stationCard.dataset.stationName = stationName;
                stationCard.dataset.routeId = currentRouteId;
                stationCard.dataset.routeName = currentRouteName;

                const isCurrentlyFavorite = isFavorite(currentRouteId, estimate.id, currentDirection);
                const iconHtml = isCurrentlyFavorite
                    ? '<span class="material-icons-outlined text-red-500">favorite</span>'
                    : '<div class="station-dot"></div>';

                stationCard.innerHTML = `
                    <div class="station-icon-container">
                        ${iconHtml}
                    </div>
                    <div class="station-content">
                        <div class="time-pill ${pillBgColorClass}">
                            <p class="text-base font-bold">${timeDisplay}</p>
                        </div>
                        <div class="station-name">
                            <p class="text-base font-medium text-slate-800">${stationName}</p>
                        </div>
                        ${busIdDisplayHtml} </div>
                `;

                stationCard.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    const stationData = {
                        routeId: parseInt(e.currentTarget.dataset.routeId),
                        routeName: e.currentTarget.dataset.routeName,
                        stationId: e.currentTarget.dataset.stationId,
                        stationName: e.currentTarget.dataset.stationName,
                        direction: currentDirection,
                        destination: currentDirection === 1 ? currentRouteData.destination : currentRouteData.departure
                    };
                    showFavoriteButton(stationData, e.clientX, e.clientY);
                });

                let touchStartPos;
                let longPressTimer;

                stationCard.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 1) {
                        touchStartPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                        longPressTimer = setTimeout(() => {
                            e.preventDefault();
                            const stationData = {
                                routeId: parseInt(e.currentTarget.dataset.routeId),
                                routeName: e.currentTarget.dataset.routeName,
                                stationId: e.currentTarget.dataset.stationId,
                                stationName: e.currentTarget.dataset.stationName,
                                direction: currentDirection,
                                destination: currentDirection === 1 ? currentRouteData.destination : currentRouteData.departure
                            };
                            showFavoriteButton(stationData, e.touches[0].clientX, e.touches[0].clientY);
                            longPressTimer = null;
                        }, 700);
                    }
                }, {passive: false});

                stationCard.addEventListener('touchmove', (e) => {
                    if (!longPressTimer || !touchStartPos) return;
                    const deltaX = Math.abs(e.touches[0].clientX - touchStartPos.x);
                    const deltaY = Math.abs(e.touches[0].clientY - touchStartPos.y);
                    if (deltaX > 10 || deltaY > 10) {
                        clearTimeout(longPressTimer);
                    }
                });

                stationCard.addEventListener('touchend', () => clearTimeout(longPressTimer));
                stationCard.addEventListener('touchcancel', () => clearTimeout(longPressTimer));

                return stationCard;
            }

            function displayEstimateTimes(data, direction, targetElement) {
                targetElement.innerHTML = '';
                const stationMap = new Map(data.stations.edges.map(edge => [edge.node.id, edge.node.name]));
                const filteredEstimates = data.estimateTimes.edges.filter(edge => edge.node.goBack === direction);

                if (!data || !data.estimateTimes || !data.estimateTimes.edges.length || filteredEstimates.length === 0) {
                    targetElement.innerHTML = `<p class="text-center py-4 text-slate-500 text-sm">${translations[currentLang].noBusDataForDirection}</p>`;
                    return;
                }

                const fragment = document.createDocumentFragment();
                const displayedBusIds = new Set();

                filteredEstimates.forEach(({ node: estimate }) => {
                    const stationName = stationMap.get(estimate.id) || `${translations[currentLang].unknownStation} (ID: ${estimate.id})`;
                    const card = createStationCard(estimate, stationName, displayedBusIds);
                    fragment.appendChild(card);
                });

                targetElement.appendChild(fragment);
            }

            function renderAllDirections(data) {
                displayEstimateTimes(data, 1, stationListGoContent);
                displayEstimateTimes(data, 2, stationListBackContent);
            }

            async function loadBusData(routeId, isInitialLoad = false, scrollToStationId = null) {
                if (isInitialLoad) {
                    trackerLoading.style.display = 'block';
                    stationListGoContent.innerHTML = '';
                    stationListBackContent.innerHTML = '';
                    stationListGo.classList.add('hidden');
                    stationListBack.classList.add('hidden');
                }
                errorMessageDiv.style.display = 'none';
                updateCountdownButton.disabled = true;

                try {
                    const result = await fetchAPI(GQL.QUERY_ROUTE_DETAILS, { routeId: parseInt(routeId), lang: currentLang });

                    if (!result.data.route) throw new Error(translations[currentLang].routeInfoNotFound);

                    currentRouteData = result.data.route;

                    renderAllDirections(currentRouteData);

                    updateDirectionButtons();

                    stationListGo.className = 'station-list-container';
                    stationListBack.className = 'station-list-container';
                    if (currentDirection === 1) {
                        stationListGo.classList.remove('hidden');
                        stationListBack.classList.add('hidden');
                    } else {
                        stationListGo.classList.add('hidden');
                        stationListBack.classList.remove('hidden');
                    }

                    if (scrollToStationId) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        const targetContainer = currentDirection === 1 ? stationListGo : stationListBack;
                        const targetStationCard = targetContainer.querySelector(`[data-station-id="${scrollToStationId}"]`);
                        if (targetStationCard) {
                            targetStationCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                } catch (error) {
                    errorMessageText.textContent = error.message;
                    errorMessageDiv.style.display = 'block';
                } finally {
                    trackerLoading.style.display = 'none';
                    updateCountdownButton.disabled = false;
                }
            }

            function navigateToTracker(routeId, routeName, routeDesc, pushState = true, scrollToStationId = null, direction = 1) {
                currentRouteId = routeId;
                currentRouteName = routeName;
                currentDirection = direction;

                showPage('busTrackerPage', pushState);

                if (pushState) {
                     const state = { page: 'busTrackerPage', routeId: routeId };
                     const url = `?page=tracker&route=${routeId}`;
                     history.pushState(state, '', url);
                }

                routeTitle.textContent = routeName;
                routeDescription.textContent = routeDesc;

                loadBusData(currentRouteId, true, scrollToStationId);
                countdownTimer.reset();
            }

            function navigateToSelection() {
                showPage('routeSelectionPage');
                currentRouteData = null;
                currentRouteId = null;
                currentRouteName = null;
                resetSearch();
                hideFavoriteButton();
            }

            // --- PAGE 3: FAVORITE STATIONS (OPTIMIZED) ---
            function createTimePillHtml(estimate) {
                let timeDisplay = translations[currentLang].lastBusDeparted;
                let pillBgColorClass = 'bg-slate-200';

                if (estimate && estimate.etas && estimate.etas.length > 0) {
                     const closestEta = estimate.etas.reduce((minEta, currentEta) => {
                        const minTime = minEta.etaTime !== null ? minEta.etaTime : Infinity;
                        const currentTime = currentEta.etaTime !== null ? currentEta.etaTime : Infinity;
                        return currentTime < minTime ? currentEta : minEta;
                    }, { etaTime: Infinity });

                    if (closestEta.etaTime !== Infinity && closestEta.etaTime !== null) {
                        if (closestEta.etaTime <= 1) {
                            timeDisplay = translations[currentLang].approaching;
                            pillBgColorClass = 'bg-red-200';
                        } else if (closestEta.etaTime <= 3) {
                            timeDisplay = translations[currentLang].arrivingSoon;
                            pillBgColorClass = 'bg-yellow-200';
                        } else {
                            timeDisplay = `${closestEta.etaTime}${translations[currentLang].minutes}`;
                            pillBgColorClass = 'bg-blue-200';
                        }
                    }
                } else if (estimate && estimate.comeTime) {
                    timeDisplay = estimate.comeTime;
                    pillBgColorClass = 'bg-slate-200';
                } else if (!estimate) {
                    timeDisplay = translations[currentLang].noData;
                }

                return `<div class="time-pill px-3 py-1 ${pillBgColorClass}">
                            <p>${timeDisplay}</p>
                        </div>`;
            }

            async function displayFavoriteStations() {
                loadFavorites();
                favoriteListContainer.innerHTML = '';

                if (favoriteStations.length === 0) {
                    noFavoritesMessage.classList.remove('hidden');
                    return;
                }

                noFavoritesMessage.classList.add('hidden');

                favoriteStations.forEach((fav, index) => {
                    const favCard = document.createElement('div');
                    favCard.className = 'favorite-card-item bg-white rounded-lg shadow-md';
                    favCard.dataset.index = index;

                    const directionText = fav.destination ? `${translations[currentLang].goDirection} ${fav.destination}` : `${translations[currentLang].direction} ${fav.direction}`;

                    favCard.innerHTML = `
                        <div class="favorite-card-content" draggable="true">
                            <div class="drag-handle">
                                <span class="material-icons-outlined">drag_indicator</span>
                            </div>
                            <div class="flex-grow ml-2 cursor-pointer card-tap-area">
                                <h3 class="font-bold text-md text-slate-800">${fav.routeName}</h3>
                                <p class="text-sm text-slate-600">${fav.stationName}</p>
                                <p class="text-xs text-slate-400 mt-1">${directionText}</p>
                            </div>
                            <div class="favorite-time-display flex-shrink-0 w-28 text-right"
                                data-route-id="${fav.routeId}"
                                data-station-id="${fav.stationId}"
                                data-direction="${fav.direction}">
                                <div class="loading-spinner h-6 w-6 border-2 ml-auto"></div>
                            </div>
                        </div>
                    `;
                    favoriteListContainer.appendChild(favCard);
                });

                addFavoriteCardEventListeners();

                // OPTIMIZATION: Fetch unique routes only
                const uniqueRouteIds = [...new Set(favoriteStations.map(f => f.routeId))];
                if (uniqueRouteIds.length === 0) return;

                const promises = uniqueRouteIds.map(routeId =>
                    fetchAPI(GQL.QUERY_ROUTE_DETAILS, { routeId: parseInt(routeId), lang: currentLang })
                );

                const results = await Promise.allSettled(promises);
                const routeDataMap = new Map();

                results.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value.data.route) {
                        const routeId = uniqueRouteIds[index];
                        routeDataMap.set(routeId, result.value.data.route);
                    }
                });

                document.querySelectorAll('.favorite-time-display').forEach(div => {
                    const { routeId, stationId, direction } = div.dataset;
                    const routeData = routeDataMap.get(Number(routeId));
                    let timeHtml = createTimePillHtml(null);

                    if (routeData) {
                        const estimate = routeData.estimateTimes.edges.find(edge =>
                            edge.node.id === stationId && edge.node.goBack === Number(direction)
                        )?.node;
                        timeHtml = createTimePillHtml(estimate);
                    }
                    div.innerHTML = timeHtml;
                });
            }

            function addFavoriteCardEventListeners() {
                favoriteListContainer.querySelectorAll('.favorite-card-item').forEach(card => {
                    const favData = favoriteStations[parseInt(card.dataset.index)];
                    const content = card.querySelector('.favorite-card-content');
                    const tapArea = card.querySelector('.card-tap-area');
                    const dragHandle = card.querySelector('.drag-handle');
                    let favLongPressTimer;
                    let isDragging = false;

                    tapArea.addEventListener('click', () => {
                         if (!isDragging) {
                            navigateToTracker(favData.routeId, favData.routeName, '', true, favData.stationId, favData.direction);
                        }
                    });

                    card.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showRemoveFavoriteButton(favData, e.clientX, e.clientY);
                    });

                    card.addEventListener('touchstart', (e) => {
                        if (dragHandle.contains(e.target)) return;
                        favLongPressTimer = setTimeout(() => {
                            e.preventDefault();
                            showRemoveFavoriteButton(favData, e.touches[0].clientX, e.touches[0].clientY);
                            favLongPressTimer = null;
                        }, 700);
                    }, { passive: false });

                    card.addEventListener('touchmove', () => clearTimeout(favLongPressTimer));
                    card.addEventListener('touchend', () => clearTimeout(favLongPressTimer));
                    card.addEventListener('touchcancel', () => clearTimeout(favLongPressTimer));

                    content.addEventListener('dragstart', (e) => {
                        if (dragHandle.contains(e.target)) {
                            isDragging = true;
                            handleDragStart.call(card, e);
                        } else {
                            e.preventDefault();
                        }
                    });

                    content.addEventListener('dragend', () => {
                        handleDragEnd.call(card);
                        setTimeout(() => isDragging = false, 100);
                    });
                });

                favoriteListContainer.addEventListener('dragover', handleDragOver);
                favoriteListContainer.addEventListener('drop', handleDrop);
            }


            function handleDragStart(e) {
                draggedItem = this;
                setTimeout(() => this.classList.add('dragging'), 0);
            }

            function handleDragEnd() {
                this.classList.remove('dragging');
                draggedItem = null;
            }

            function handleDragOver(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(favoriteListContainer, e.clientY);
                if (afterElement == null) {
                    favoriteListContainer.appendChild(draggedItem);
                } else {
                    favoriteListContainer.insertBefore(draggedItem, afterElement);
                }
            }

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.favorite-card-item:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            function handleDrop(e) {
                e.preventDefault();
                const newOrderedElements = [...favoriteListContainer.querySelectorAll('.favorite-card-item')];
                const newFavoritesArray = newOrderedElements.map(elem => favoriteStations[parseInt(elem.dataset.index)]);

                favoriteStations = newFavoritesArray;
                saveFavorites();
                displayFavoriteStations();
            }

            // --- PAGE 5: HOME (WEATHER) ---
            const getWeatherDescription = (code) => {
                switch (code) {
                    case 0: return translations[currentLang].weatherClear;
                    case 1: return translations[currentLang].weatherMostlyClear;
                    case 2: return translations[currentLang].weatherPartlyCloudy;
                    case 3: return translations[currentLang].weatherOvercast;
                    case 45: return translations[currentLang].weatherFog;
                    case 48: return translations[currentLang].weatherDepositingFog;
                    case 51: return translations[currentLang].weatherDrizzleLight;
                    case 53: return translations[currentLang].weatherDrizzleModerate;
                    case 55: return translations[currentLang].weatherDrizzleDense;
                    case 56: return translations[currentLang].weatherFreezingDrizzleLight;
                    case 57: return translations[currentLang].weatherFreezingDrizzleDense;
                    case 61: return translations[currentLang].weatherRainLight;
                    case 63: return translations[currentLang].weatherRainModerate;
                    case 65: return translations[currentLang].weatherRainHeavy;
                    case 66: return translations[currentLang].weatherFreezingRainLight;
                    case 67: return translations[currentLang].weatherFreezingRainHeavy;
                    case 71: return translations[currentLang].weatherSnowLight;
                    case 73: return translations[currentLang].weatherSnowModerate;
                    case 75: return translations[currentLang].weatherSnowHeavy;
                    case 77: return translations[currentLang].weatherSnowGrains;
                    case 80: return translations[currentLang].weatherRainShowersLight;
                    case 81: return translations[currentLang].weatherRainShowersModerate;
                    case 82: return translations[currentLang].weatherRainShowersHeavy;
                    case 85: return translations[currentLang].weatherSnowShowersLight;
                    case 86: return translations[currentLang].weatherSnowShowersHeavy;
                    case 95: return translations[currentLang].weatherThunderstorm;
                    case 96: return translations[currentLang].weatherThunderstormHailLight;
                    case 99: return translations[currentLang].weatherThunderstormHailHeavy;
                    default: return translations[currentLang].weatherUnknown;
                }
            };

            const getWeatherIcon = (code, isDay) => {
                switch (code) {
                    case 0: return isDay ? "☀️" : "🌙";
                    case 1: return isDay ? "🌤️" : "☁️";
                    case 2: return isDay ? "⛅" : "☁️";
                    case 3: return "☁️";
                    case 45: return "🌫️";
                    case 48: return "🌫️";
                    case 51: return "🌧️";
                    case 53: return "🌧️";
                    case 55: return "🌧️";
                    case 56: return "🌨️";
                    case 57: return "🌨️";
                    case 61: return "🌧️";
                    case 63: return "🌧️";
                    case 65: return "☔";
                    case 66: return "🧊🌧️";
                    case 67: return "🧊🌧️";
                    case 71: return "❄️";
                    case 73: return "❄️";
                    case 75: return "❄️";
                    case 77: return "🌨️";
                    case 80: return "⛈️";
                    case 81: return "⛈️";
                    case 82: return "⛈️";
                    case 85: return "🌨️";
                    case 86: return "🌨️";
                    case 95: return "⚡";
                    case 96: return "⚡";
                    case 99: return "⚡";
                    default: return "❓";
                }
            };

            const fetchWeather = async () => {
                weatherLoadingElement.classList.remove('hidden');
                weatherErrorMessageElement.classList.add('hidden');
                weatherInfoElement.classList.add('hidden');

                const today = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                currentDateElement.textContent = today.toLocaleDateString(currentLang === 'zh' ? 'zh-TW' : 'en-US', options);

                const latitude = 22.6273;
                const longitude = 120.3014;
                const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,weather_code,wind_speed_10m&timezone=Asia%2FTaipei&forecast_days=1`;

                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
                    }
                    const data = await response.json();

                    const current = data.current;
                    if (current) {
                        temperatureElement.textContent = current.temperature_2m;
                        apparentTemperatureElement.textContent = `${current.apparent_temperature}°C`;
                        relativeHumidityElement.textContent = `${current.relative_humidity_2m}%`;
                        windSpeedElement.textContent = `${current.wind_speed_10m} km/h`;

                        const weatherCode = current.weather_code;
                        const isDay = current.is_day;
                        const weatherDescription = getWeatherDescription(weatherCode);
                        const weatherIcon = getWeatherIcon(weatherCode, isDay);

                        weatherDescriptionElement.textContent = weatherDescription;
                        weatherIconElement.textContent = weatherIcon;

                        weatherInfoElement.classList.remove('hidden');
                    } else {
                        throw new Error(translations[currentLang].weatherLoadError);
                    }
                } catch (error) {
                    console.error("取得天氣資料時發生錯誤:", error);
                    weatherErrorMessageElement.textContent = translations[currentLang].weatherLoadError;
                    weatherErrorMessageElement.classList.remove('hidden');
                } finally {
                    weatherLoadingElement.classList.add('hidden');
                }
            };

            // --- 訊息公告邏輯 ---
            async function fetchAnnouncements() {
                loadFavorites();
                if (favoriteStations.length === 0) {
                    announcementLoading.classList.add('hidden');
                    noAnnouncementsMessage.classList.remove('hidden');
                    announcementContent.innerHTML = '';
                    announcementContent.appendChild(noAnnouncementsMessage);
                    announcementsDataLoaded = true;
                    return;
                }

                announcementLoading.classList.remove('hidden');
                noAnnouncementsMessage.classList.add('hidden');
                announcementContent.innerHTML = '';


                const uniqueRouteIds = [...new Set(favoriteStations.map(fav => fav.routeId))];
                let allMessages = [];

                try {
                    const promises = uniqueRouteIds.map(routeId =>
                        fetchAPI(GQL.QUERY_CLOGS, { routeId: parseInt(routeId) })
                    );
                    const results = await Promise.allSettled(promises);

                    results.forEach((result, index) => {
                        if (result.status === 'fulfilled' && result.value.data) {
                            const routeId = uniqueRouteIds[index];
                            const favRoute = favoriteStations.find(fav => fav.routeId === routeId);
                            const routeName = favRoute ? favRoute.routeName : `Route ${routeId}`;


                            const clogMessages = result.value.data.clogMessages?.edges || [];
                            const abnormalMessages = result.value.data.abnormalMessages?.edges || [];

                            clogMessages.forEach(edge => {
                                allMessages.push({
                                    type: 'clog',
                                    routeId: routeId,
                                    routeName: routeName,
                                    id: edge.node.id,
                                    title: edge.node.title,
                                    description: edge.node.description
                                });
                            });

                            abnormalMessages.forEach(edge => {
                                allMessages.push({
                                    type: 'abnormal',
                                    routeId: routeId,
                                    routeName: routeName,
                                    id: edge.node.id,
                                    title: edge.node.title,
                                    description: edge.node.description
                                });
                            });
                        } else if (result.status === 'rejected') {
                            console.error(`Failed to fetch announcements for routeId: ${uniqueRouteIds[index]}`, result.reason);
                        }
                    });

                    const groupedMessages = new Map();
                    allMessages.forEach(msg => {
                        const key = `${msg.title}|||${msg.description}`;
                        if (groupedMessages.has(key)) {
                            const existingEntry = groupedMessages.get(key);
                            if (!existingEntry.routeNames.includes(msg.routeName)) {
                                existingEntry.routeNames.push(msg.routeName);
                            }
                        } else {
                            groupedMessages.set(key, {
                                title: msg.title,
                                description: msg.description,
                                routeNames: [msg.routeName]
                            });
                        }
                    });

                    renderAnnouncements(Array.from(groupedMessages.values()));

                } catch (error) {
                    console.error("取得訊息公告時發生錯誤:", error);
                    announcementContent.innerHTML = `<p class="text-center py-4 text-red-500">${translations[currentLang].weatherLoadError}</p>`;
                } finally {
                    announcementLoading.classList.add('hidden');
                    announcementsDataLoaded = true;
                }
            }

            function renderAnnouncements(messages) {
                announcementContent.innerHTML = '';
                if (messages.length === 0) {
                    noAnnouncementsMessage.classList.remove('hidden');
                    announcementContent.appendChild(noAnnouncementsMessage);
                } else {
                    messages.forEach(msg => {
                        const messageCard = document.createElement('div');
                        messageCard.className = 'announcement-item bg-blue-100 dark:bg-slate-700 p-3 rounded-lg shadow-sm mb-3 border border-blue-200 dark:border-slate-600';

                        const routeNamesHtml = msg.routeNames.map(name =>
                            `<span class="inline-block px-2 py-0.5 rounded bg-blue-200 text-blue-800 font-medium text-xs dark:bg-blue-800 dark:text-blue-200">${name}</span>`
                        ).join(' ');

                        messageCard.innerHTML = `
                            <h3 class="font-semibold text-slate-800 dark:text-slate-200">${routeNamesHtml} - ${msg.title}</h3>
                            <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">${msg.description}</p>
                        `;
                        announcementContent.appendChild(messageCard);
                    });
                }
            }


            // --- Update Countdown Logic ---
            let countdownTimer = {
                remaining: 30,
                updateButton: document.getElementById('updateCountdown'),
                updateDisplay: function() {
                    const text = `${this.remaining}${translations[currentLang].updateCountdown}`;
                    document.getElementById('updateCountdownText').textContent = text;
                },
                reset: function() {
                    const icon = this.updateButton.querySelector('.material-icons-outlined');
                    icon.classList.add('spin-update');
                    setTimeout(() => icon.classList.remove('spin-update'), 500);
                    this.remaining = 30;
                    this.updateDisplay();
                },
                update: async function() {
                    this.reset();
                    if (busTrackerPage.classList.contains('active') && currentRouteId) {
                        await loadBusData(currentRouteId, false);
                    }
                }
            };

            function adjustContentPadding() {
                const mainNavHeight = mainNav.offsetHeight;
                filterKeyboardContainer.style.display = 'block';
                const keyboardHeight = filterKeyboardContainer.offsetHeight;
                if (!routeSelectionPage.classList.contains('active')) {
                    filterKeyboardContainer.style.display = 'none';
                }
                const totalFixedBottomHeight = mainNavHeight + keyboardHeight + 10;

                const routeSelectionContainer = document.querySelector('#routeSelectionPage .container');
                if (routeSelectionContainer) {
                    routeSelectionContainer.style.paddingBottom = `${totalFixedBottomHeight}px`;
                }
            }

            // --- Event Listeners ---
            backButton.addEventListener('click', () => history.back());


            goDirectionButton.addEventListener('click', () => handleDirectionToggle(1));
            backDirectionButton.addEventListener('click', () => handleDirectionToggle(2));

            const estimateTimesSection = document.getElementById('estimateTimesSection');
            estimateTimesSection.addEventListener('touchstart', (e) => {
                if (e.touches.length !== 1) return;
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchEndX = 0;
                touchEndY = 0;
            }, { passive: true });

            estimateTimesSection.addEventListener('touchmove', (e) => {
                if (e.touches.length !== 1) return;
                touchEndX = e.touches[0].clientX;
                touchEndY = e.touches[0].clientY;
            }, { passive: true });

            estimateTimesSection.addEventListener('touchend', () => {
                if (touchEndX === 0) return;

                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;

                if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
                    handleDirectionToggle(diffX > 0 ? 2 : 1);
                }

                touchStartX = 0;
                touchStartY = 0;
                touchEndX = 0;
                touchEndY = 0;
            });

            updateCountdownButton.addEventListener('click', () => {
                countdownTimer.update();
            });

            mainNav.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const page = button.dataset.page;

                if (page === 'dynamic') {
                    resetSearch();
                    showPage('routeSelectionPage');
                }
                else if (page === 'favorites') showPage('favoriteStationsPage');
                else if (page === 'mrt') showPage('mrtPage');
                else if (page === 'home') showPage('homePage');
                else if (page === 'settings') showPage('settingsPage');
            });


            document.addEventListener('click', (e) => {
                if (!favoriteActionButton.contains(e.target) && favoriteActionButton.classList.contains('show')) {
                    hideFavoriteButton();
                }
            });

            // --- Initial Load Logic ---
            loadFavorites();
            applyInitialTheme();
            currentLang = localStorage.getItem("lang") || "zh";
            languageSelect.value = currentLang;
            applyTranslations();

            await initRouteSelection();

            adjustContentPadding();
            window.addEventListener('resize', adjustContentPadding);

            const urlParams = new URLSearchParams(window.location.search);
            let pageFromUrl = urlParams.get('page');
            const routeIdFromUrl = urlParams.get('route');

            let initialPage = 'homePage';

            if(pageFromUrl) {
                switch(pageFromUrl) {
                    case 'dynamic': initialPage = 'routeSelectionPage'; break;
                    case 'tracker':
                        if (routeIdFromUrl) {
                            const route = allRoutes.find(r => r.id.toString() === routeIdFromUrl);
                            if (route) {
                                setTimeout(() => navigateToTracker(route.id, route.name, route.description, false), 0);
                                initialPage = 'busTrackerPage';
                            } else {
                                initialPage = 'routeSelectionPage';
                            }
                        } else {
                            initialPage = 'routeSelectionPage';
                        }
                        break;
                    case 'favorites': initialPage = 'favoriteStationsPage'; break;
                    case 'mrt': initialPage = 'mrtPage'; break;
                    case 'settings': initialPage = 'settingsPage'; break;
                    case 'home': initialPage = 'homePage'; break;
                }
            }

            showPage(initialPage, false);
            history.replaceState({ page: initialPage }, '', window.location.href);

            countdownInterval = setInterval(() => {
                if (busTrackerPage.classList.contains('active') && navigator.onLine) {
                    updateCountdownButton.style.display = "flex";
                    countdownTimer.remaining--;
                    if (countdownTimer.remaining <= 0) {
                        countdownTimer.update();
                    }
                    countdownTimer.updateDisplay();
                } else {
                    updateCountdownButton.style.display = "none";
                }
            }, 1000);

            window.addEventListener('online', () => {
                if (busTrackerPage.classList.contains('active')) {
                    updateCountdownButton.style.display = "flex";
                    countdownTimer.update();
                }
            });

            window.addEventListener('offline', () => {
                updateCountdownButton.style.display = "none";
            });

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && busTrackerPage.classList.contains('active') && navigator.onLine) {
                    countdownTimer.update();
                }
            });
        });
    </script>
</body>
</html>
