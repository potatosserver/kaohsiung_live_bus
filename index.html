<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公車動態查詢器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #334155;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 900px;
            margin-top: 20px;
        }
        h1 {
            color: #1e293b;
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }
        h2 {
            color: #334155;
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 25px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }
        /* Styling for the station list items */
        .station-item {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .station-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .station-item .time-status {
            flex-shrink: 0;
            width: 100px; /* Fixed width for time display */
            text-align: center;
        }
        .station-item .station-name {
            flex-grow: 1;
            margin-left: 16px;
            margin-right: 16px;
        }
        .station-item .bus-id {
            flex-shrink: 0;
            width: 80px; /* Fixed width for bus ID */
            text-align: right;
            font-weight: 600;
            color: #475569;
        }
        .button-group {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        .refresh-button {
            background-color: #3b82f6;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        .refresh-button:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }
        .refresh-button:active {
            transform: translateY(0);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #ef4444;
            background-color: #fee2e2;
            border: 1px solid #fca5a5;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            text-align: center;
            font-weight: 500;
            display: none;
        }
        /* Styling for the segmented direction toggle */
        .direction-toggle-group {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden; /* Ensures rounded corners apply to the group */
            border: 1px solid #cbd5e1; /* Subtle border for the group */
        }
        .direction-button {
            flex: 1; /* Makes buttons take equal width */
            background-color: #f8fafc; /* Light background for inactive */
            color: #475569;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .direction-button:first-child {
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        .direction-button:last-child {
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        .direction-button.active {
            background-color: #3b82f6; /* Blue background for active */
            color: white;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1); /* Inner shadow for active state */
        }
        .direction-button:hover:not(.active) {
            background-color: #e2e8f0; /* Slightly darker hover for inactive */
        }
        /* Style for the route input group */
        .route-input-group {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }
        .route-input-group input[type="text"] {
            padding: 10px 15px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            width: 150px;
            max-width: 100%;
        }
        .route-input-group button {
            background-color: #10b981; /* Green color for switch button */
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s ease;
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }
        .route-input-group button:hover {
            background-color: #059669;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>公車動態查詢器</h1>

        <!-- Route ID Input and Switch Button -->
        <div class="route-input-group">
            <input type="text" id="routeIdInput" placeholder="輸入路線代號 (例如: 856)" value="856">
            <button id="switchRouteButton">切換路線</button>
        </div>

        <div class="button-group">
            <button id="refreshButton" class="refresh-button">
                <span id="refreshText">更新數據</span>
                <span id="loadingSpinner" class="loading-spinner"></span>
            </button>
        </div>

        <div id="errorMessage" class="error-message">
            載入數據時發生錯誤。請稍後再試。
        </div>

        <!-- Direction Toggle Buttons as a Segmented Control -->
        <div class="direction-toggle-group">
            <button id="goDirectionButton" class="direction-button active" data-direction="1">去程</button>
            <button id="backDirectionButton" class="direction-button" data-direction="2">返程</button>
        </div>

        <div id="estimateTimesSection">
            <h2>預計到站時間</h2>
            <div id="stationList" class="space-y-4">
                <!-- Station cards will be rendered here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = 'https://ibus.tbkc.gov.tw/ibus/graphql';

            // Headers extracted directly from the 856.txt curl command
            const HEADERS = {
                'Accept-Language': 'zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-CN;q=0.6',
                'Connection': 'keep-alive',
                'Origin': 'https://ibus.tbkc.gov.tw',
                'Referer': 'https://ibus.tbkc.gov.tw/ibus/driving-map/856',
                'Sec-Fetch-Dest': 'empty',
                'Sec-Fetch-Mode': 'cors',
                'Sec-Fetch-Site': 'same-origin',
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36',
                'accept': '*/*',
                'content-type': 'application/json',
                'sec-ch-ua': '"Not)A;Brand";v="8", "Chromium";v="138", "Google Chrome";v="138"',
                'sec-ch-ua-mobile': '?0',
                'sec-ch-ua-platform': '"Windows"',
                'Cookie': '_ga=GA1.1.998906947.1752413536; _ga_YD5S4Y1RMZ=GS2.1.s1752418127$o2$g0$t1752418127$j60$l0$h0; _ga_CF7EG0W7E4=GS2.1.s1752419784$o1$g0$t1752419793$j51$l0$h0; XSRF-TOKEN=eyJpdiI6IktsRlA2bjZNOEVcLytPbFRvXC9wZWl0QT09IiwidmFsdWUiOiJIYVllZ3A5dWdkZU82emVoZ0ZcL3RXTHhGWVg2MGp0aEdBMDZYSCsyemZ0STVYVm9xZEpZNFNKMVZqYld5aXF0eitEem50bE52TVhjTTdIZEZOdGxTb2c9PSIsIm1hYyI6IjIzNGJkYjQ2YmYzNGJhNzc3ZjIwYzY1YTZhNjVlODYzY2ZjMWQzZjMzN2NkNWQzODI3YTljN2VmOGI4NmRiNGEifQ%3D%3D; laravel_session=eyJpdiI6IlEwZ3c4RVNOWXRReXVtMUNuRmE2Nmc9PSIsIndmZ3c8fHJvcGU+dmFsdWUiOiJON3puR1YzQ2JBUzhHRlZPd3lVQkRsQ0J0cWZqTHJBOWJrdERTK1V6OWYweTBqdmxMUXJwdWIzOWVnXFwvZlVlV2pmSUpESGN0TmozRjFUV21mNjNrZmpRPT0iLCJtYWMiOiIyM2UzNjNkYjM2Y2ZmMGI5N2VlZTRkY2RlYjk1NjkwZjAzMWMyZmRkNjU2NzI0ODNmMjFjOWEyMDRjMGU1Y2Y1In0%3D'
            };

            // GraphQL queries and variables extracted from the 856.txt curl commands
            const GRAPHQL_QUERIES = {
                QUERY_ESTIMATE_TIMES: {
                    operationName: "QUERY_ESTIMATE_TIMES",
                    variables: { lang: "zh", routeId: 856 },
                    query: `query QUERY_ESTIMATE_TIMES($routeId: Int!, $lang: String!) {
    route(xno: $routeId, lang: $lang) {
        opType
        departure
        destination
        estimateTimes {
            ...estimateTimesFragment
            __typename
        }
        stations {
            ...routeStationsFragment
            __typename
        }
        buses {
            ...busesFragment
            __typename
        }
        __typename
    }
}

fragment routeStationsFragment on RouteStationConnection {
    edges {
        ivrNo
        node {
            id
            name
            __typename
        }
        __typename
    }
    __typename
}

fragment estimateTimesFragment on EstimateTimeConnection {
    edges {
        node {
            id
            goBack
            comeTime
            clogType
            etas {
                busId
                etaTime
                isLast
                __typename
            }
            __typename
        }
        __typename
    }
    __typename
}

fragment busesFragment on RouteBusConnection {
    edges {
        goBack
        node {
            id
            type
            lat
            lon
            type
            azimuth
            status
            dutyStatus
            capacity
            isCrowded
            dataTime
            __typename
        }
        __typename
    }
    __typename
}`
                },
                QUERY_ROUTE_FOR_MAP_CONTENT: {
                    operationName: "QUERY_ROUTE_FOR_MAP_CONTENT",
                    variables: { lang: "zh", routeId: 856 },
                    query: `query QUERY_ROUTE_FOR_MAP_CONTENT($routeId: Int!, $lang: String!) {
    route(xno: $routeId, lang: $lang) {
        id
        name
        opType
        providers {
            ...providersFragment
            __typename
        }
        routePoint {
            go
            back
            __typename
        }
        buses {
            ...busesFragment
            __typename
        }
        stations {
            ...mapMarkerStationsFragment
            __typename
        }
        __typename
    }
}

fragment busesFragment on RouteBusConnection {
    edges {
        goBack
        node {
            id
            type
            lat
            lon
            type
            azimuth
            status
            dutyStatus
            capacity
            isCrowded
            dataTime
            __typename
        }
        __typename
    }
    __typename
}

fragment mapMarkerStationsFragment on RouteStationConnection {
    edges {
        goBack
        orderNo
        ivrNo
        node {
            id
            name
            lat
            lon
            routes {
                edges {
                    goBack
                    node {
                        id
                        name
                        departure
                        destination
                        __typename
                    }
                    __typename
                }
                __typename
            }
            __typename
        }
        __typename
    }
    __typename
}

fragment providersFragment on ProviderConnection {
    edges {
        node {
            id
            name
            url
            __typename
        }
        __typename
    }
    __typename
}`
                },
                QUERY_BUSES: {
                    operationName: "QUERY_BUSES",
                    variables: { lang: "zh", routeId: 856 },
                    query: `query QUERY_BUSES($routeId: Int!, $lang: String!) {
    route(xno: $routeId, lang: $lang) {
        buses {
            ...busesFragment
            __typename
        }
        __typename
    }
}

fragment busesFragment on RouteBusConnection {
    edges {
        goBack
        node {
            id
            type
            lat
            lon
            type
            azimuth
            status
            dutyStatus
            capacity
            isCrowded
            dataTime
            __typename
        }
        __typename
    }
    __typename
}`
                }
            };

            // DOM elements
            const routeIdInput = document.getElementById('routeIdInput');
            const switchRouteButton = document.getElementById('switchRouteButton');
            const stationListDiv = document.getElementById('stationList');
            const refreshButton = document.getElementById('refreshButton');
            const refreshText = document.getElementById('refreshText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const errorMessageDiv = document.getElementById('errorMessage');
            const goDirectionButton = document.getElementById('goDirectionButton');
            const backDirectionButton = document.getElementById('backDirectionButton');

            // Global variable to store the fetched route data
            let currentRouteData = null;
            // Default direction: 1 for Go (去程), 2 for Back (返程)
            let currentDirection = 1;

            /**
             * Converts Unix timestamp to a readable date and time string.
             * This function is now only used for bus dataTime, not for comeTime.
             * @param {string} unixTimestamp - The Unix timestamp string.
             * @returns {string} Formatted date and time string.
             */
            function formatUnixTimestamp(unixTimestamp) {
                if (!unixTimestamp) return 'N/A';
                const date = new Date(parseInt(unixTimestamp) * 1000);
                return date.toLocaleString('zh-TW', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            /**
             * Fetches data from the GraphQL API.
             * @param {object} queryData - Object containing operationName, variables, and query string.
             * @param {number} routeId - The bus route ID to query.
             * @returns {Promise<object>} The JSON response data.
             */
            async function fetchBusData(queryData, routeId) {
                try {
                    // Update the routeId in the query variables
                    const updatedQueryData = {
                        ...queryData,
                        variables: { ...queryData.variables, routeId: routeId }
                    };

                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: HEADERS,
                        body: JSON.stringify(updatedQueryData)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.data.route; // Return the route object directly
                } catch (error) {
                    console.error("Error fetching data:", queryData.operationName, error);
                    throw error; // Re-throw to be caught by the caller
                }
            }

            /**
             * Renders estimated arrival times for stations in an app-like layout, filtered by direction.
             * @param {object} data - The route data containing estimate times and station information.
             * @param {number} direction - The direction to filter by (1 for Go, 2 for Back).
             */
            function displayEstimateTimes(data, direction) {
                stationListDiv.innerHTML = ''; // Clear previous data

                if (!data || !data.estimateTimes || !data.estimateTimes.edges.length) {
                    stationListDiv.innerHTML = `<p class="text-center py-4 text-gray-500">目前沒有預計到站時間資訊。</p>`;
                    return;
                }

                // Create a map for quick station name lookup
                const stationMap = new Map();
                if (data.stations && data.stations.edges) {
                    data.stations.edges.forEach(edge => {
                        stationMap.set(edge.node.id, edge.node.name);
                    });
                }

                // Filter estimates by the current direction
                const filteredEstimates = data.estimateTimes.edges.filter(edge => edge.node.goBack === direction);

                if (filteredEstimates.length === 0) {
                    stationListDiv.innerHTML = `<p class="text-center py-4 text-gray-500">此方向目前沒有預計到站時間資訊。</p>`;
                    return;
                }

                filteredEstimates.forEach(edge => {
                    const estimate = edge.node;
                    const stationName = stationMap.get(estimate.id) || `未知站點 (ID: ${estimate.id})`;
                    let timeDisplay = '<span class="text-gray-500">N/A</span>'; // Default display
                    let busIdDisplay = ''; // Default to empty, only show for approaching bus

                    if (estimate.etas && estimate.etas.length > 0) {
                        const firstEta = estimate.etas[0];
                        if (firstEta.etaTime !== undefined && firstEta.etaTime !== null) {
                            if (firstEta.etaTime === 0) {
                                timeDisplay = '<span class="px-3 py-1 bg-green-500 text-white rounded-full text-sm font-semibold">即將到站</span>';
                                busIdDisplay = firstEta.busId ? `<span class="text-gray-600 text-sm font-semibold">${firstEta.busId}</span>` : '';
                            } else if (firstEta.etaTime === 1) {
                                timeDisplay = '<span class="px-3 py-1 bg-blue-500 text-white rounded-full text-sm font-semibold">進站中</span>';
                                busIdDisplay = firstEta.busId ? `<span class="text-gray-600 text-sm font-semibold">${firstEta.busId}</span>` : '';
                            } else {
                                // Display remaining minutes
                                timeDisplay = `<span class="text-xl font-bold text-blue-700">${firstEta.etaTime} 分鐘</span>`;
                            }
                        } else if (estimate.comeTime) {
                            // Fallback to comeTime if etaTime is not available, use comeTime directly
                            timeDisplay = `<span class="text-xl font-bold text-gray-700">${estimate.comeTime}</span>`;
                        } else {
                            // If no ETA and no comeTime, display "末班駛離"
                            timeDisplay = '<span class="text-gray-500">末班駛離</span>';
                        }
                    } else if (estimate.comeTime) {
                        // If no ETAs at all, use comeTime directly
                        timeDisplay = `<span class="text-xl font-bold text-gray-700">${estimate.comeTime}</span>`;
                    } else {
                        // If no ETAs and no comeTime, display "末班駛離"
                        timeDisplay = '<span class="text-gray-500">末班駛離</span>';
                    }

                    const stationCard = document.createElement('div');
                    stationCard.className = 'station-item'; // Use the new class for styling
                    stationCard.innerHTML = `
                        <div class="time-status">
                            ${timeDisplay}
                        </div>
                        <div class="station-name">
                            <p class="text-lg font-medium text-gray-800">${stationName}</p>
                        </div>
                        <div class="bus-id">
                            ${busIdDisplay}
                        </div>
                    `;
                    stationListDiv.appendChild(stationCard);
                });
            }

            /**
             * Handles the direction toggle button click.
             * @param {Event} event - The click event object.
             */
            function handleDirectionToggle(event) {
                const clickedButton = event.target;
                const newDirection = parseInt(clickedButton.dataset.direction);

                if (newDirection !== currentDirection) {
                    currentDirection = newDirection;

                    // Update active button styling
                    goDirectionButton.classList.remove('active');
                    backDirectionButton.classList.remove('active');
                    clickedButton.classList.add('active');

                    // Re-render the station list with the new direction
                    if (currentRouteData) {
                        displayEstimateTimes(currentRouteData, currentDirection);
                    }
                }
            }

            /**
             * Main function to load and display all bus data.
             * Now accepts an optional routeId parameter.
             * @param {number|null} newRouteId - The new route ID to load, or null to use the current input value.
             */
            async function loadBusData(newRouteId = null) {
                refreshButton.disabled = true;
                refreshText.style.display = 'none';
                loadingSpinner.style.display = 'block';
                errorMessageDiv.style.display = 'none';

                const routeId = newRouteId !== null ? newRouteId : parseInt(routeIdInput.value);

                if (isNaN(routeId) || routeId <= 0) {
                    errorMessageDiv.textContent = '請輸入有效的路線代號 (正整數)。';
                    errorMessageDiv.style.display = 'block';
                    refreshButton.disabled = false;
                    refreshText.style.display = 'inline';
                    loadingSpinner.style.display = 'none';
                    return;
                }

                try {
                    // Fetch all data concurrently using the dynamic routeId
                    const [estimateTimesData, mapContentData, busesData] = await Promise.all([
                        fetchBusData(GRAPHQL_QUERIES.QUERY_ESTIMATE_TIMES, routeId),
                        fetchBusData(GRAPHQL_QUERIES.QUERY_ROUTE_FOR_MAP_CONTENT, routeId),
                        fetchBusData(GRAPHQL_QUERIES.QUERY_BUSES, routeId)
                    ]);

                    // Combine data for rendering
                    currentRouteData = {
                        ...mapContentData, // Contains id, name, opType, providers, routePoint, stations
                        ...estimateTimesData, // Contains estimateTimes, (overwrites stations and buses if present but we use mapContentData's stations)
                        buses: busesData.buses, // Ensure the latest bus data is used
                    };

                    // Display estimate times for the current direction
                    displayEstimateTimes(currentRouteData, currentDirection);

                } catch (error) {
                    console.error("Failed to load bus data:", error);
                    errorMessageDiv.textContent = `載入路線 ${routeId} 的數據時發生錯誤。請稍後再試。`;
                    errorMessageDiv.style.display = 'block';
                } finally {
                    refreshButton.disabled = false;
                    refreshText.style.display = 'inline';
                    loadingSpinner.style.display = 'none';
                }
            }

            // Event listener for the refresh button
            refreshButton.addEventListener('click', () => loadBusData()); // Call without specific routeId to use current input

            // Event listener for the switch route button
            switchRouteButton.addEventListener('click', () => {
                const newRouteId = parseInt(routeIdInput.value);
                loadBusData(newRouteId); // Pass the new routeId directly
            });

            // Event listeners for direction toggle buttons
            goDirectionButton.addEventListener('click', handleDirectionToggle);
            backDirectionButton.addEventListener('click', handleDirectionToggle);

            // Load data when the page loads (using the default value in the input field)
            loadBusData(parseInt(routeIdInput.value));
        });
    </script>
</body>
</html>
