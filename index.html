<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高雄市公車動態查詢器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 將 Material Icons 引入改為 Outlined 樣式 -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
        }
        /* Loading Spinner Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1.2s linear infinite;
        }
        /* Page transition styles */
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f8fafc;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Removed filter-active for category buttons */
        /* 更新 Material Icons 的類別名稱 */
        .material-icons-outlined {
            font-size: 24px;
        }
        /* Ensure the body has enough padding at the bottom for the fixed keyboard */
        #routeSelectionPage .container {
            /* Adjusted to reduce the large spacing at the bottom */
            padding-bottom: 20px;
        }
        @media (min-width: 768px) { /* Adjust for larger screens if needed */
            #routeSelectionPage .container {
                /* Adjusted for larger screens */
                padding-bottom: 30px;
            }
        }

        /* For "公車小黃" button to wrap text on narrow screens */
        .bus-taxi-button {
            line-height: 1.2; /* 調整行高以更好地換行 */
            white-space: normal; /* 允許文字換行 */
            display: flex; /* 使用 flexbox 居中內容 */
            flex-direction: column; /* 將內容垂直堆疊 */
            align-items: center; /* 垂直居中 */
            justify-content: center; /* 水平居中 */
            text-align: center; /* 確保文字在其行內居中 */
            /* 調整內邊距，減少水平內邊距以提供更多文字空間 */
            padding: 0.4rem 0.2rem; 
        }

        /* 讓公車和小黃在窄螢幕時強制換行 */
        .bus-taxi-button .bus-text,
        .bus-taxi-button .taxi-text {
            display: block; 
        }

        @media (min-width: 768px) {
            .bus-taxi-button {
                /* 在大螢幕上恢復標準內邊距 */
                padding: 0.75rem;
                flex-direction: row; /* 在大螢幕上恢復水平排列 */
                white-space: nowrap; /* 在寬螢幕時不換行 */
            }
            /* 在大螢幕時，讓公車和小黃恢復行內顯示 */
            .bus-taxi-button .bus-text,
            .bus-taxi-button .taxi-text {
                display: inline;
            }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Route Selection Page -->
    <div id="routeSelectionPage" class="page active">
        <div class="container mx-auto p-4 md:p-6 max-w-4xl">
            <header class="text-center mb-6">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-800">高雄市公車路線查詢</h1>
                <p class="text-slate-500 mt-2">請使用下方鍵盤或直接輸入以查詢路線</p>
            </header>
            
            <!-- Search input section (remains at top) -->
            <div class="relative mb-4">
                <input type="text" id="routeSearchInput" placeholder="請由下方鍵盤或直接輸入" class="w-full p-4 pl-12 text-lg bg-white border-2 border-slate-300 rounded-xl shadow-sm transition text-center focus:ring-2 focus:ring-blue-500 focus:border-blue-500" readonly>
                <svg class="w-6 h-6 text-slate-400 absolute top-1/2 left-4 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </div>

            <div id="initialLoading" class="text-center py-20">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-4 text-slate-600">正在載入所有路線...</p>
            </div>
            
            <div id="routeListContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-4">
                <!-- Route items will be injected here -->
            </div>
             <p id="noResultsMessage" class="text-center py-10 text-slate-500 text-lg hidden">找不到相符的路線。</p>
        </div>

        <!-- Filter Keyboard (moved to bottom and fixed) -->
        <div id="filterKeyboardContainer" class="fixed bottom-0 left-0 right-0 bg-slate-100 py-0 px-4 z-[999] shadow-lg">
            <div class="container mx-auto max-w-4xl">
                <!-- 調整鍵盤按鈕之間的水平間距為更小，以提供更多空間 -->
                <div id="filterKeyboard" class="grid grid-cols-5 gap-x-0.5 gap-y-1 md:gap-2 py-2">
                    <!-- Row 1 -->
                    <button data-filter="紅" data-type="category" class="p-3 text-black font-bold bg-red-500 rounded-lg shadow-md hover:bg-red-600 transition-colors">紅</button>
                    <button data-filter="其他" data-type="category" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">其他</button>
                    <button data-filter="1" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">1</button>
                    <button data-filter="2" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">2</button>
                    <button data-filter="3" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">3</button>
                    
                    <!-- Row 2 -->
                    <button data-filter="橘" data-type="category" class="p-3 text-black font-bold bg-orange-500 rounded-lg shadow-md hover:bg-orange-600 transition-colors">橘</button>
                    <button data-filter="幹線" data-type="category" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">幹線</button>
                    <button data-filter="4" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">4</button>
                    <button data-filter="5" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">5</button>
                    <button data-filter="6" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">6</button>

                    <!-- Row 3 -->
                    <button data-filter="黃" data-type="category" class="p-3 text-black font-bold bg-yellow-400 rounded-lg shadow-md hover:bg-yellow-500 transition-colors">黃</button>
                    <!-- "快線" button: data-filter is "E", but textContent is "快線" -->
                    <button data-filter="E" data-type="category" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">快線</button>
                    <button data-filter="7" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">7</button>
                    <button data-filter="8" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">8</button>
                    <button data-filter="9" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">9</button>

                    <!-- Row 4 -->
                    <button data-filter="綠" data-type="category" class="p-3 text-black font-bold bg-green-500 rounded-lg shadow-md hover:bg-green-600 transition-colors">綠</button>
                    <!-- "公車小黃" button: data-filter is "小黃", textContent is "公車小黃" -->
                    <!-- 移除 p-3 Tailwind 類別，完全由 bus-taxi-button CSS 控制內邊距 -->
                    <button data-filter="小黃" data-type="category" class="bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors bus-taxi-button"><span class="bus-text">公車</span><span class="taxi-text">小黃</span></button>
                    <button data-filter="reset" data-type="action" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">重設</button>
                    <button data-filter="0" data-type="number" class="p-3 bg-white rounded-lg shadow-md hover:bg-slate-100 transition-colors">0</button>
                    <button data-filter="backspace" data-type="action" class="p-3 bg-white text-slate-800 hover:bg-slate-100 rounded-lg shadow-md transition-colors flex justify-center items-center">
                        <!-- 將 class 從 material-icons 改為 material-icons-outlined -->
                        <span class="material-icons-outlined">backspace</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bus Tracker Page -->
    <div id="busTrackerPage" class="page">
        <div class="container mx-auto p-4 md:p-6 max-w-4xl">
            <header class="flex items-center justify-between mb-4">
                 <button id="backButton" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    返回路線列表
                </button>
                <button id="refreshButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center gap-2 shadow-md hover:shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                    </svg>
                    <span id="refreshText">更新</span>
                </button>
            </header>
            
            <div id="trackerLoading" class="text-center py-20">
                <div class="loading-spinner mx-auto"></div>
                <p class="mt-4 text-slate-600">正在載入路線動態...</p>
            </div>

            <div id="trackerContent" class="hidden">
                <h1 id="routeTitle" class="text-2xl md:text-3xl font-bold text-slate-800 text-center mb-2"></h1>
                <p id="routeDescription" class="text-slate-500 text-center mb-6"></p>

                <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
                    <strong class="font-bold">錯誤!</strong>
                    <span class="block sm:inline" id="errorMessageText"></span>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-md">
                    <div class="direction-toggle-group flex justify-center mb-4 rounded-lg border-2 border-blue-500 overflow-hidden">
                        <button id="goDirectionButton" class="direction-button flex-1 p-3 font-semibold transition-colors" data-direction="1">去程</button>
                        <button id="backDirectionButton" class="direction-button flex-1 p-3 font-semibold transition-colors" data-direction="2">返程</button>
                    </div>

                    <div id="estimateTimesSection">
                        <div id="stationList" class="space-y-3">
                            <!-- Station cards will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIG & GLOBAL VARS ---
            const API_URL = 'https://ibus.tbkc.gov.tw/ibus/graphql';
            const HEADERS = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            };

            // --- DOM ELEMENTS ---
            const routeSelectionPage = document.getElementById('routeSelectionPage');
            const busTrackerPage = document.getElementById('busTrackerPage');
            const routeSearchInput = document.getElementById('routeSearchInput');
            const routeListContainer = document.getElementById('routeListContainer');
            const initialLoading = document.getElementById('initialLoading');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const filterKeyboard = document.getElementById('filterKeyboard'); // This is the grid itself
            const filterKeyboardContainer = document.getElementById('filterKeyboardContainer'); // The new container for the fixed keyboard
            
            const backButton = document.getElementById('backButton');
            const refreshButton = document.getElementById('refreshButton');
            const trackerLoading = document.getElementById('trackerLoading');
            const trackerContent = document.getElementById('trackerContent');
            const routeTitle = document.getElementById('routeTitle');
            const routeDescription = document.getElementById('routeDescription');
            const stationListDiv = document.getElementById('stationList');
            const errorMessageDiv = document.getElementById('errorMessage');
            const errorMessageText = document.getElementById('errorMessageText');
            const goDirectionButton = document.getElementById('goDirectionButton');
            const backDirectionButton = document.getElementById('backDirectionButton');

            // --- STATE ---
            let allRoutes = [];
            let currentRouteData = null;
            let currentDirection = 1; // 1 for Go, 2 for Back
            let currentRouteId = null;
            const categoryFilters = [
                { prefix: '公車小黃', filterValue: '小黃' }, // Specific: '公車小黃' should be checked before '黃'
                { prefix: '紅', filterValue: '紅' },
                { prefix: '橘', filterValue: '橘' },
                { prefix: '黃', filterValue: '黃' },
                { prefix: '綠', filterValue: '綠' },
                { prefix: '其他', filterValue: '其他' },
                { prefix: '幹線', filterValue: '幹線' },
                { prefix: '快線', filterValue: 'E' }
            ];


            const GQL = {
                QUERY_SIDE_ROUTES: `query QUERY_SIDE_ROUTES($lang: String!) {
                    routes(lang: $lang) {
                        edges {
                            node {
                                id, opType, id, seq, name, description
                            }
                        }
                    }
                }`,
                QUERY_ROUTE_DETAILS: `query QUERY_ESTIMATE_TIMES($routeId: Int!, $lang: String!) {
                    route(xno: $routeId, lang: $lang) {
                        opType, departure, destination
                        estimateTimes { edges { node { id, goBack, comeTime, etas { busId, etaTime } } } }
                        stations { edges { ivrNo, node { id, name } } }
                    }
                }`
            };
            async function fetchAPI(query, variables) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: HEADERS,
                        body: JSON.stringify({ query, variables })
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    console.error("API Fetch Error:", error);
                    throw error;
                }
            }

            // --- PAGE 1: ROUTE SELECTION ---
            async function initRouteSelection() {
                try {
                    const data = await fetchAPI(GQL.QUERY_SIDE_ROUTES, { lang: "zh" });
                    allRoutes = data.data.routes.edges
                        .map(edge => edge.node)
                        .filter(route => route.id !== 0)
                        .sort((a, b) => a.seq - b.seq);
                    
                    initialLoading.style.display = 'none';
                    
                    // Check URL for routeId on initial load
                    const urlParams = new URLSearchParams(window.location.search);
                    const routeIdFromUrl = urlParams.get('route');

                    if (routeIdFromUrl) {
                        const route = allRoutes.find(r => r.id.toString() === routeIdFromUrl);
                        if (route) {
                            navigateToTracker(route.id, route.name, route.description, false); // Don't push state again
                        } else {
                            displayInitialPrompt(); // Route not found, show initial prompt
                            history.replaceState(null, '', window.location.pathname); // Clean URL
                        }
                    } else {
                        displayInitialPrompt();
                    }

                } catch (error) {
                    initialLoading.innerHTML = '<p class="text-red-500">無法載入路線列表，請重新整理頁面。</p>';
                }
            }

            function displayInitialPrompt() {
                routeListContainer.innerHTML = `
                    <div id="initialPrompt" class="text-center col-span-full py-10 text-slate-500">
                        <p class="text-lg">請使用鍵盤或直接輸入開始搜尋路線。</p>
                    </div>`;
                noResultsMessage.style.display = 'none';
            }

            function displayRoutes(routes) {
                routeListContainer.innerHTML = '';
                if (routes.length === 0) {
                    noResultsMessage.style.display = 'block';
                } else {
                    noResultsMessage.style.display = 'none';
                }
                
                routes.forEach(route => {
                    const card = document.createElement('div');
                    card.className = 'route-card p-4 bg-white rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer border-l-4 border-transparent hover:border-blue-500';
                    card.dataset.routeId = route.id;
                    card.dataset.routeName = route.name;
                    card.dataset.routeDesc = route.description;
                    
                    card.innerHTML = `
                        <h3 class="font-bold text-lg text-slate-800">${route.name}</h3>
                        <p class="text-sm text-slate-500">${route.description}</p>
                    `;
                    card.addEventListener('click', () => {
                        navigateToTracker(card.dataset.routeId, card.dataset.routeName, card.dataset.routeDesc, true); // Push state
                    });
                    routeListContainer.appendChild(card);
                });
            }

            // Modified applySearch function to prioritize category search
            function applySearch(searchTerm) {
                const lowerCaseTerm = searchTerm.toLowerCase().trim();
                
                if (!lowerCaseTerm) {
                    displayInitialPrompt();
                    return;
                }

                let filteredRoutes = [...allRoutes]; // Start with all routes

                let categoryMatched = false;
                let remainingSearchTerm = lowerCaseTerm;

                // Try to match a category prefix first
                for (const category of categoryFilters) {
                    const lowerCasePrefix = category.prefix.toLowerCase();
                    if (lowerCaseTerm.startsWith(lowerCasePrefix)) {
                        // Apply category filter based on the filterValue
                        if (category.filterValue === '其他') {
                            filteredRoutes = filteredRoutes.filter(route =>
                                route.name.toLowerCase().includes('joy') ||
                                route.name.toLowerCase().includes('大樹')
                            );
                        } else if (category.filterValue === 'E') { // 快線
                            filteredRoutes = filteredRoutes.filter(route =>
                                route.name.toLowerCase().startsWith('e')
                            );
                        } else if (category.filterValue === '小黃') { // 公車小黃
                            filteredRoutes = filteredRoutes.filter(route =>
                                route.name.toLowerCase().includes('小黃')
                            );
                        } else if (category.filterValue === '黃') { // 黃, but not 小黃
                            filteredRoutes = filteredRoutes.filter(route =>
                                route.name.toLowerCase().includes('黃') && !route.name.toLowerCase().includes('小黃')
                            );
                        } else { // Generic category (紅, 橘, 綠, 幹線)
                            filteredRoutes = filteredRoutes.filter(route =>
                                route.name.toLowerCase().includes(category.filterValue.toLowerCase())
                            );
                        }

                        remainingSearchTerm = lowerCaseTerm.substring(lowerCasePrefix.length).trim();
                        categoryMatched = true;
                        break; // Found a category, break the loop
                    }
                }

                // If there's a remaining search term (after category prefix) or no category was matched,
                // apply general search to the current filtered set.
                if (remainingSearchTerm) {
                    filteredRoutes = filteredRoutes.filter(route =>
                        route.name.toLowerCase().includes(remainingSearchTerm)
                    );
                }
                
                displayRoutes(filteredRoutes);
            }

            filterKeyboard.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const value = button.dataset.filter;
                const type = button.dataset.type;

                if (type === 'category') {
                    if (button.dataset.filter === '小黃') {
                        routeSearchInput.value = '公車小黃'; 
                    } else {
                        routeSearchInput.value = button.textContent;
                    }
                } else if (type === 'number') {
                    routeSearchInput.value += value;
                } else if (type === 'action') {
                    if (value === 'reset') {
                        routeSearchInput.value = '';
                    } else if (value === 'backspace') {
                        routeSearchInput.value = routeSearchInput.value.slice(0, -1);
                    }
                }
                
                const event = new Event('input', { bubbles: true, cancelable: true });
                routeSearchInput.dispatchEvent(event);
            });

            routeSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value;
                const categoryButtons = document.querySelectorAll('[data-type="category"]');
                categoryButtons.forEach(btn => {
                    btn.classList.remove('filter-active');
                });

                applySearch(searchTerm);
            });
            function updateDirectionButtons() {
                if (currentDirection === 1) {
                    goDirectionButton.classList.add('bg-blue-500', 'text-white');
                    goDirectionButton.classList.remove('bg-white', 'text-blue-500');
                    backDirectionButton.classList.add('bg-white', 'text-blue-500');
                    backDirectionButton.classList.remove('bg-blue-500', 'text-white');
                } else {
                    backDirectionButton.classList.add('bg-blue-500', 'text-white');
                    backDirectionButton.classList.remove('bg-white', 'text-blue-500');
                    goDirectionButton.classList.add('bg-white', 'text-blue-500');
                    goDirectionButton.classList.remove('bg-blue-500', 'text-white');
                }
            }
            
            function handleDirectionToggle(event) {
                const newDirection = parseInt(event.currentTarget.dataset.direction);
                if (newDirection !== currentDirection) {
                    currentDirection = newDirection;
                    updateDirectionButtons();
                    if (currentRouteData) {
                        displayEstimateTimes(currentRouteData, currentDirection);
                    }
                }
            }

            function displayEstimateTimes(data, direction) {
                stationListDiv.innerHTML = '';
                errorMessageDiv.style.display = 'none';

                if (!data || !data.estimateTimes || !data.estimateTimes.edges.length) {
                    stationListDiv.innerHTML = `<p class="text-center py-4 text-slate-500">目前沒有預計到站時間資訊。</p>`;
                    return;
                }

                const stationMap = new Map(data.stations.edges.map(edge => [edge.node.id, edge.node.name]));
                const filteredEstimates = data.estimateTimes.edges.filter(edge => edge.node.goBack === direction);

                if (filteredEstimates.length === 0) {
                    stationListDiv.innerHTML = `<p class="text-center py-4 text-slate-500">此方向目前沒有班次資訊。</p>`;
                    return;
                }

                filteredEstimates.forEach(({ node: estimate }) => {
                    const stationName = stationMap.get(estimate.id) || `未知站點 (ID: ${estimate.id})`;
                    let timeDisplay = '<span class="text-slate-400">末班駛離</span>';
                    let busIdDisplay = '';
                    let timeColorClass = 'text-slate-500';

                    if (estimate.etas && estimate.etas.length > 0) {
                        const firstEta = estimate.etas[0];
                        if (firstEta.etaTime !== null) {
                            if (firstEta.etaTime <= 1) {
                                timeDisplay = '進站中';
                                timeColorClass = 'text-red-500 animate-pulse';
                            } else if (firstEta.etaTime <= 5) {
                                // Removed " 分"
                                timeDisplay = `${firstEta.etaTime}`;
                                timeColorClass = 'text-orange-500';
                            } else {
                                // Removed " 分"
                                timeDisplay = `${firstEta.etaTime}`;
                                timeColorClass = 'text-blue-600';
                            }
                            busIdDisplay = firstEta.busId ? `<span class="text-xs bg-slate-200 text-slate-600 font-mono px-2 py-1 rounded">${firstEta.busId}</span>` : '';
                        }
                    } else if (estimate.comeTime) {
                        timeDisplay = estimate.comeTime;
                        timeColorClass = 'text-slate-700';
                    }

                    const stationCard = document.createElement('div');
                    stationCard.className = 'flex items-center justify-between p-4 bg-slate-50 rounded-lg';
                    stationCard.innerHTML = `
                        <div class="flex-1">
                            <p class="text-lg font-medium text-slate-800">${stationName}</p>
                        </div>
                        <div class="flex items-center gap-4 justify-end"> <!-- Removed w-40 -->
                            <div class="text-right flex-1 min-w-[40px]"> <!-- Added min-w to prevent time text from collapsing -->
                                <p class="text-lg font-bold ${timeColorClass}">${timeDisplay}</p>
                            </div>
                            <div class="flex-none">${busIdDisplay}</div> <!-- Removed w-20, added flex-none -->
                        </div>
                    `;
                    stationListDiv.appendChild(stationCard);
                });
            }
            
            async function loadBusData(routeId) {
                trackerLoading.style.display = 'flex';
                trackerContent.style.display = 'none';
                errorMessageDiv.style.display = 'none';
                refreshButton.disabled = true;

                try {
                    const result = await fetchAPI(GQL.QUERY_ROUTE_DETAILS, { routeId: parseInt(routeId), lang: "zh" });
                    
                    if (!result.data.route) {
                        throw new Error("找不到該路線的資訊，請確認路線代號是否正確。");
                    }
                    
                    currentRouteData = result.data.route;
                    displayEstimateTimes(currentRouteData, currentDirection);
                    trackerContent.style.display = 'block';

                } catch (error) {
                    errorMessageText.textContent = error.message;
                    errorMessageDiv.style.display = 'block';
                } finally {
                    trackerLoading.style.display = 'none';
                    refreshButton.disabled = false;
                }
            }
            function navigateToTracker(routeId, routeName, routeDesc, pushState = true) {
                currentRouteId = routeId;
                routeSelectionPage.classList.remove('active');
                busTrackerPage.classList.add('active');
                const url = `${window.location.pathname}?route=${routeId}`;
                if (pushState) {
                    history.pushState({ page: 'tracker', routeId: routeId }, '', url);
                } else {
                    history.replaceState({ page: 'tracker', routeId: routeId }, '', url);
                }

                routeTitle.textContent = routeName;
                routeDescription.textContent = routeDesc;
                currentDirection = 1;
                updateDirectionButtons();
                
                loadBusData(currentRouteId);
            }

            function navigateToSelection() {
                busTrackerPage.classList.remove('active');
                routeSelectionPage.classList.add('active');
                currentRouteData = null;
                currentRouteId = null;
                history.pushState({ page: 'selection' }, '', window.location.pathname);
            }

            backButton.addEventListener('click', navigateToSelection);
            refreshButton.addEventListener('click', () => {
                if(currentRouteId) loadBusData(currentRouteId);
            });
            goDirectionButton.addEventListener('click', handleDirectionToggle);
            backDirectionButton.addEventListener('click', handleDirectionToggle);
            window.addEventListener('popstate', (event) => {
                const urlParams = new URLSearchParams(window.location.search);
                const routeIdFromUrl = urlParams.get('route');

                if (routeIdFromUrl) {
                    const route = allRoutes.find(r => r.id.toString() === routeIdFromUrl);
                    if (route) {
                        navigateToTracker(route.id, route.name, route.description, false);
                    } else {
                        navigateToSelection();
                    }
                } else {
                    navigateToSelection();
                }
            });
            initRouteSelection();
        });
    </script>
</body>
</html>
